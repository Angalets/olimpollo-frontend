<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Olimpollo - Lista de Pedidos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  
  <style>
    /* ==========================================================================
       BASE DE ESTILOS UNIFICADA
       ========================================================================== */
    :root{--bg-main:#ECF0F1;--bg-header:#FFFFFF;--card-bg:#FFFFFF;--primary-text:#502c2c;--secondary-text:#808B96;--accent-color:#db3434;--accent-hover:#b92929;--border-color:#D5D8DC;--shadow-light:0 4px 15px rgba(0, 0, 0, 0.08);--shadow-heavy:0 10px 20px rgba(0, 0, 0, 0.12);}body{margin:0;font-family:'Poppins', sans-serif;background-color:var(--bg-main);color:var(--primary-text);display:flex;flex-direction:column;min-height:100vh;}header{background:var(--bg-header);padding:15px 40px;box-shadow:0 2px 10px rgba(0, 0, 0, 0.05);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);}header .logo{font-size:24px;font-weight:600;text-decoration:none;color:var(--primary-text);}header nav{display:flex;gap:20px;}header nav a{text-decoration:none;color:var(--secondary-text);font-weight:500;transition:color 0.3s;}header nav a:hover{color:var(--accent-color);}.user-info{display:flex;align-items:center;gap:20px;}#user-identifier{font-weight:500;background-color:var(--bg-main);padding:5px 12px;border-radius:15px;font-size:14px;}.logout{background:var(--accent-color);color:white;border:none;padding:8px 18px;border-radius:20px;cursor:pointer;font-size:14px;font-weight:500;transition:background-color 0.3s;}.logout:hover{background-color:var(--accent-hover);}main{flex:1;padding:40px;max-width:1400px;margin:0 auto;width:100%;box-sizing:border-box;}h1, h2, h3{margin-top:0;}h2.page-title{margin-bottom:30px;font-size:28px;font-weight:600;}.card{background:var(--card-bg);border-radius:12px;padding:25px;box-shadow:var(--shadow-light);margin-bottom:25px;}table{width:100%;border-collapse:collapse;background:var(--card-bg);border-radius:12px;overflow:hidden;box-shadow:var(--shadow-light);}th, td{padding:15px;text-align:left;border-bottom:1px solid var(--bg-main);}th{font-weight:600;font-size:14px;text-transform:uppercase;color:var(--secondary-text);background-color:#F8F9F9;}tr:hover{background-color:#FDF2F2;}.btn{border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:500;font-family:'Poppins', sans-serif;transition:background-color 0.3s, transform 0.2s;}.btn:hover{transform:translateY(-2px);}.btn-primary{background-color:var(--accent-color);color:white;}.btn-primary:hover{background-color:var(--accent-hover);}.btn-secondary{background-color:var(--secondary-text);color:white;}.btn-secondary:hover{background-color:#6C7A89;}.btn-danger{background-color:#E74C3C;color:white;}.btn-success{background-color:#2ECC71;color:white;}label{display:block;margin-bottom:8px;font-weight:500;font-size:14px;}input[type="text"],input[type="password"],input[type="number"],input[type="date"],select,textarea{width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;font-family:'Poppins', sans-serif;font-size:14px;box-sizing:border-box;transition:border-color 0.3s, box-shadow 0.3s;}input:focus, select:focus, textarea:focus{outline:none;border-color:var(--accent-color);box-shadow:0 0 0 3px rgba(219, 52, 52, 0.1);}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);justify-content:center;align-items:center;}.modal-content{background:var(--card-bg);padding:30px;border-radius:12px;box-shadow:var(--shadow-heavy);width:90%;max-width:500px;position:relative;}.close{position:absolute;top:15px;right:20px;font-size:28px;cursor:pointer;color:var(--secondary-text);}footer{text-align:center;padding:20px;font-size:14px;color:var(--secondary-text);}

    /* Estilos espec√≠ficos para esta p√°gina */
    .layout-container { display: flex; gap: 25px; flex-wrap: wrap; }
    .pedidos-lista { flex: 3; min-width: 450px; }
    .detalles { flex: 1; min-width: 300px; align-self: flex-start; }
    .detalles ul { list-style: none; padding: 0; }
    .filtros-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; align-items: flex-end; }
    
    /* Estilos para el desglose financiero */
    .finance-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 14px; }
    .finance-total { border-top: 1px solid #eee; margin-top: 10px; padding-top: 10px; font-weight: bold; font-size: 16px; }
    .finance-neto { color: #27ae60; font-size: 18px; margin-top: 5px; }
    .finance-comision { color: #e74c3c; }
  </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">Olimpollo</a>
        <nav>
          <a href="pedidos.html">POS</a>
          <a href="reportes.html">Reportes</a>
          <a href="pedidos_lista.html">Pedidos</a>
          <a href="inventario.html">Inventario</a>
        </nav>
        <div class="user-info">
            <span id="user-identifier"></span>
            <button class="logout" id="btn-logout">Cerrar Sesi√≥n</button>
        </div>
    </header>

  <main>
    <h2 class="page-title">Historial de √ìrdenes</h2>
    
    <div class="card">
        <div class="filtros-grid">
            <div>
                <label for="filtro-canal">Filtrar por Canal:</label>
                <select id="filtro-canal">
                    <option value="Todos">Todos los Canales</option>
                    <option value="OyR">OyR</option>
                    <option value="Uber">Uber</option>
                    <option value="Didi">Didi</option>
                    <option value="Rappi">Rappi</option>
                    <option value="Empleado">Empleado</option>
                </select>
            </div>
            <div>
                <label for="filtro-fecha-inicio">Desde:</label>
                <input type="date" id="filtro-fecha-inicio">
            </div>
            <div>
                <label for="filtro-fecha-fin">Hasta:</label>
                <input type="date" id="filtro-fecha-fin">
            </div>
            <button id="btn-aplicar-filtro" class="btn btn-primary">Aplicar Filtro</button>
        </div>
    </div>
    
    <div class="layout-container">
      <div class="pedidos-lista">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Canal</th>
                    <th>Cliente</th>
                    <th>Estado</th>
                    <th>Total</th>
                    <th>Fecha</th> <th>Hora</th>
                    <th>Acciones</th> 
                </tr>
            </thead>
            <tbody id="tabla-pedidos-body"></tbody>
        </table>
      </div>

      <div class="detalles card">
          <h3 id="detalle-titulo">Detalles del Pedido</h3>
          <div id="detalle-contenido"><p>Selecciona un pedido para ver sus detalles.</p></div>
          <div id="panel-acciones" style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;"></div>
      </div>
    </div>
  </main>

  <footer>&copy; 2025 Los Boneless del Olimpo</footer>

<script>
function parseJwt(token) { try { const base64Url = token.split('.')[1]; const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/'); const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); return JSON.parse(jsonPayload); } catch (e) { return null; } }

document.addEventListener('DOMContentLoaded', () => {

    const API_PEDIDOS_URL = 'https://olimpollo-api.onrender.com/api/pedidos';
    const tablaBody = document.getElementById('tabla-pedidos-body');
    const detalleContenido = document.getElementById('detalle-contenido');
    const panelAcciones = document.getElementById('panel-acciones');

    const filtroCanal = document.getElementById('filtro-canal');
    const filtroFechaInicio = document.getElementById('filtro-fecha-inicio');
    const filtroFechaFin = document.getElementById('filtro-fecha-fin');
    const btnAplicarFiltro = document.getElementById('btn-aplicar-filtro');

    let pedidos = []; 
    let pedidoSeleccionado = null;

    // --- 1. VERIFICACI√ìN Y SESI√ìN ---
    const token = localStorage.getItem('authToken');
    if(token) {
        const userData = parseJwt(token);
        if (userData && userData.username) document.getElementById('user-identifier').textContent = userData.username;
    } else {
        window.location.href = 'login.html';
    }
    const cerrarSesion = () => {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userRole');
        window.location.href = 'login.html';
    };
    document.getElementById('btn-logout').addEventListener('click', cerrarSesion);

    // --- 2. FUNCI√ìN PRINCIPAL DE RENDERIZADO CON FILTROS ---
    const renderPedidos = async () => {
        const canal = filtroCanal.value;
        const fechaInicio = filtroFechaInicio.value;
        const fechaFin = filtroFechaFin.value;

        let params = new URLSearchParams();
        if (canal && canal !== 'Todos') params.append('canal', canal);
        if (fechaInicio) params.append('fechaInicio', fechaInicio);
        if (fechaFin) params.append('fechaFin', fechaFin);
        
        const queryString = params.toString();
        const url = queryString ? `${API_PEDIDOS_URL}?${queryString}` : API_PEDIDOS_URL;

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Error al cargar pedidos.');

            pedidos = await response.json();
            tablaBody.innerHTML = '';

            if (pedidos.length === 0) {
                 tablaBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No se encontraron pedidos para este filtro.</td></tr>';
                 mostrarDetalles(null);
                 return;
            }

            pedidos.forEach(pedido => {
                const tr = document.createElement('tr');
                tr.dataset.pedidoId = pedido.id;

                let colorEstado = '';
                if (pedido.estado === 'Entregado') colorEstado = 'style="background-color: #d4edda; font-weight: bold;"';
                else if (pedido.estado === 'Cancelado') colorEstado = 'style="background-color: #f8d7da; text-decoration: line-through;"';

                const fechaObj = new Date(pedido.fecha_creacion);
                const fecha = fechaObj.toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const hora = fechaObj.toLocaleTimeString('es-MX', {hour: '2-digit', minute:'2-digit'});
                const canal = pedido.canal_venta || 'N/A'; 

                tr.innerHTML = `
                    <td>${pedido.id.toString().padStart(3, '0')}</td>
                    <td>${canal}</td>
                    <td>${pedido.cliente}</td>
                    <td ${colorEstado}>${pedido.estado}</td>
                    <td>$${pedido.total.toFixed(2)}</td>
                    <td>${fecha}</td>
                    <td>${hora}</td>
                    <td><button class="btn btn-secondary btn-detalle" data-id="${pedido.id}">Ver</button></td>
                `;
                tablaBody.appendChild(tr);
            });
            mostrarDetalles(null); 
        } catch (error) {
            console.error('Error al cargar pedidos:', error);
            tablaBody.innerHTML = '<tr><td colspan="8" style="color:red; font-weight:bold;">Error: No se pudo cargar la lista de pedidos.</td></tr>';
        }
    };

 // --- 3. IMPRESI√ìN DE TICKETS CON LOGO ---
    const imprimirTicket = (pedido) => {
        const ventana = window.open('', 'PRINT', 'height=600,width=300');
        const fechaObj = new Date(pedido.fecha_creacion);
        const fecha = fechaObj.toLocaleDateString('es-MX');
        const hora = fechaObj.toLocaleTimeString('es-MX', {hour: '2-digit', minute:'2-digit'});

        let itemsHTML = '';
        pedido.items.forEach(item => {
            itemsHTML += `
                <tr>
                    <td class="col-cant">${item.cantidad}</td>
                    <td class="col-prod">
                        ${item.nombre_producto}
                        ${item.notas ? `<br><small>(${item.notas})</small>` : ''}
                    </td>
                    <td class="col-prec">$${(item.precio_unitario * item.cantidad).toFixed(2)}</td>
                </tr>`;
        });

        ventana.document.write(`
            <html>
            <head>
                <title>Ticket #${pedido.id}</title>
                <style>
                    body { font-family: 'Courier New', monospace; font-size: 12px; width: 58mm; margin: 0; padding: 5px; color: black; }
                    .header { text-align: center; margin-bottom: 10px; }
                    
                    /* ESTILOS DEL LOGO */
                    .logo-ticket { 
                        width: 140px; 
                        max-width: 100%; 
                        margin-bottom: 5px; 
                        filter: grayscale(100%) contrast(150%); 
                    }

                    .header h2 { margin: 0; font-size: 16px; font-weight: bold; }
                    .header p { margin: 2px 0; }
                    .divider { border-bottom: 1px dashed black; margin: 5px 0; }
                    .info { font-size: 11px; margin-bottom: 5px; }
                    .items { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
                    .items td { padding: 2px 0; vertical-align: top; }
                    .col-cant { width: 10%; text-align: center; }
                    .col-prod { width: 65%; }
                    .col-prec { width: 25%; text-align: right; }
                    .totals { text-align: right; margin-top: 5px; font-size: 12px; }
                    .total-big { font-size: 16px; font-weight: bold; margin-top: 5px; }
                    .footer { text-align: center; margin-top: 15px; font-size: 10px; }
                    @media print { @page { margin: 0; } body { margin: 0; } }
                </style>
            </head>
            <body>
                <div class="header">
                    <img src="https://i.postimg.cc/tCYLDScF/logo250.png" class="logo-ticket" alt="Logo Olimpollo">
                    <p>Los Boneless del Olimpo</p>
                    <p>Hermosillo, Sonora</p>
                    <div class="divider"></div>
                </div>
                
                <div class="info">
                    <strong>Folio: #${pedido.id.toString().padStart(4, '0')}</strong><br>
                    Fecha: ${fecha} ${hora}<br>
                    Cliente: ${pedido.cliente}<br>
                    Canal: ${pedido.canal_venta || 'Mostrador'}
                </div>
                <div class="divider"></div>

                <table class="items">
                    ${itemsHTML}
                </table>
                <div class="divider"></div>

                <div class="totals">
                    Total: <div class="total-big">$${pedido.total.toFixed(2)}</div>
                    <small>Pago: ${pedido.metodo_pago || 'Efectivo'}</small>
                </div>

                <div class="footer">
                    <p>¬°Gracias por tu compra!</p>
                    <p>Wifi: OlimpolloGuest</p>
                    <p>********</p>
                </div>
            </body>
            </html>
        `);

        ventana.document.close();
        ventana.focus();
        
        // Esperamos 800ms para asegurar que el logo cargue
        setTimeout(() => {
            ventana.print();
            ventana.close();
        }, 800);
    };
    // --- 4. FUNCI√ìN DE DETALLES Y ACCIONES (MEJORADA) üí° ---
    const mostrarDetalles = (id) => {
        detalleContenido.innerHTML = '<p>Selecciona un pedido de la lista para ver sus detalles.</p>';
        panelAcciones.innerHTML = '';

        if (!id) return;
        pedidoSeleccionado = pedidos.find(p => p.id == id);
        if (!pedidoSeleccionado) return;

        // --- C√ÅLCULOS FINANCIEROS REALES ---
        const total = parseFloat(pedidoSeleccionado.total);
        const comision = parseFloat(pedidoSeleccionado.comision || 0);
        const ingresoNeto = total - comision;
        const metodo = pedidoSeleccionado.metodo_pago || 'Desconocido';

        // Icono seg√∫n m√©todo
        let iconoPago = 'üí∞';
        if (metodo.includes('Tarjeta')) iconoPago = 'üí≥';
        if (metodo.includes('Aplicaci√≥n')) iconoPago = 'üì±';
        if (metodo.includes('Transferencia')) iconoPago = 'üè¶';

        // Renderizado de Items
        let itemsHTML = '';
        pedidoSeleccionado.items.forEach(item => {
            const subtotal = item.cantidad * item.precio_unitario;
            itemsHTML += `<li style="margin-bottom: 5px; border-bottom: 1px dashed #eee; padding-bottom: 5px;">
                <div style="display:flex; justify-content:space-between;">
                    <span><strong>${item.cantidad}x</strong> ${item.nombre_producto}</span>
                    <span>$${subtotal.toFixed(2)}</span>
                </div>
                ${item.notas ? `<small style="color:orange;">üìù ${item.notas}</small>` : ''}
            </li>`;
        });

        // HTML DEL DETALLE MEJORADO
        detalleContenido.innerHTML = `
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h3 style="margin:0; color: var(--accent-color);">#${pedidoSeleccionado.id.toString().padStart(4, '0')} - ${pedidoSeleccionado.cliente}</h3>
                <small style="color: gray;">
                    ${new Date(pedidoSeleccionado.fecha_creacion).toLocaleDateString('es-MX')} 
                    ${new Date(pedidoSeleccionado.fecha_creacion).toLocaleTimeString('es-MX', {hour: '2-digit', minute:'2-digit'})}
                </small>
                <div style="margin-top: 10px;">
                    <strong>Canal:</strong> ${pedidoSeleccionado.canal_venta || 'OyR'} | 
                    <strong>Estado:</strong> ${pedidoSeleccionado.estado}
                </div>
            </div>

            <div style="border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="margin-top:0; border-bottom: 2px solid #eee; padding-bottom: 5px;">üìä Desglose Financiero</h4>
                
                <div class="finance-row">
                    <span>M√©todo de Pago:</span>
                    <strong>${iconoPago} ${metodo}</strong>
                </div>

                <div class="finance-row finance-total">
                    <span>Total Cobrado:</span>
                    <span>$${total.toFixed(2)}</span>
                </div>

                ${comision > 0 ? `
                <div class="finance-row finance-comision">
                    <span>- Comisi√≥n:</span>
                    <span>$${comision.toFixed(2)}</span>
                </div>
                ` : ''}

                <div class="finance-row">
                    <span style="align-self: flex-end; font-weight:500;">Ingreso Neto:</span>
                    <strong class="finance-neto">$${ingresoNeto.toFixed(2)}</strong>
                </div>
            </div>

            <h4>Productos:</h4>
            <ul>${itemsHTML}</ul>
        `;

        // BOTONES DE ACCI√ìN
        let botonesHTML = `
            <button id="btn-imprimir-ticket" class="btn btn-secondary" style="background-color: #34495e; color: white; width:100%;">üñ®Ô∏è Imprimir Ticket</button>
        `;

        if (pedidoSeleccionado.estado === 'Pendiente') {
            botonesHTML += `
                <button id="btn-marcar-entregado" class="btn btn-success" data-id="${id}">Marcar Entregado</button>
                <button id="btn-marcar-cancelado" class="btn btn-danger" data-id="${id}">Marcar Cancelado</button>
            `;
        } else {
            botonesHTML += `
                <button id="btn-eliminar-registro" class="btn btn-danger" style="background-color: #7f8c8d;" data-id="${id}" title="Borrar del historial permanentemente">
                    üóëÔ∏è Eliminar Registro
                </button>
            `;
        }
        panelAcciones.innerHTML = botonesHTML;
    };

    // --- 5. EVENT LISTENERS ---
    panelAcciones.addEventListener('click', async (e) => {
        const id = pedidoSeleccionado?.id;
        if (!id) return;

        if (e.target.id === 'btn-imprimir-ticket') {
            imprimirTicket(pedidoSeleccionado);
        } 
        else if (e.target.id === 'btn-marcar-entregado') {
            if (confirm(`¬øConfirmas marcar el Pedido #${id} como ENTREGADO?`)) cambiarEstado(id, 'Entregado');
        } 
        else if (e.target.id === 'btn-marcar-cancelado') {
            if (confirm(`¬øConfirmas marcar el Pedido #${id} como CANCELADO?`)) cambiarEstado(id, 'Cancelado');
        } 
        else if (e.target.id === 'btn-eliminar-registro') {
            if (confirm(`‚ö†Ô∏è ¬øEst√°s seguro de ELIMINAR DEFINITIVAMENTE el Pedido #${id}?`)) {
                try {
                    const response = await fetch(`${API_PEDIDOS_URL}/${id}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('No se pudo eliminar.');
                    alert('Pedido eliminado del historial.');
                    renderPedidos(); mostrarDetalles(null);
                } catch (error) { alert('Error: ' + error.message); }
            }
        }
    });

    const cambiarEstado = async (id, nuevoEstado) => {
        try {
            const response = await fetch(`${API_PEDIDOS_URL}/${id}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ estado: nuevoEstado }) 
            });
            if (!response.ok) throw new Error('Error al actualizar estado.');
            alert(`Pedido #${id} actualizado a ${nuevoEstado} con √©xito.`);
            renderPedidos(); 
        } catch (error) { console.error(error); alert('Fallo al cambiar el estado.'); }
    };

    btnAplicarFiltro.addEventListener('click', renderPedidos);
    tablaBody.addEventListener('click', (e) => {
        const detalleBtn = e.target.closest('.btn-detalle');
        if (detalleBtn) mostrarDetalles(detalleBtn.dataset.id);
    });

    renderPedidos(); 
});
</script>
</body>
</html>
