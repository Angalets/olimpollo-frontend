<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Olimpollo - Panel Principal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    /* Paleta de colores y estilos base */
    :root {
      --bg-main: #ECF0F1;
      --bg-header: #FFFFFF;
      --primary-text: #502c2c;
      --secondary-text: #808B96;
      --accent-color: #db3434;
      --card-bg: #FFFFFF;
      --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      --success-color: #27AE60;
      --warning-color: #F39C12;
      --danger-color: #E74C3C;
    }

    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-main);
      color: var(--primary-text);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* Header */
    header {
      background: var(--bg-header);
      padding: 15px 40px; 
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #EAECEE;
    }
    .logo { font-size: 24px; font-weight: 600; color: var(--primary-text); }
    .user-info { display: flex; align-items: center; gap: 20px; }
    #user-identifier {
      font-weight: 500;
      background-color: var(--bg-main);
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 14px;
    }
    .logout {
      background: var(--accent-color);
      color: white;
      border: none;
      padding: 8px 18px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background-color 0.3s;
    }
    .logout:hover { background-color: #b92929; }

    /* Contenido Principal */
    main {
      flex: 1;
      padding: 40px;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
    }
    .welcome-message {
      margin-bottom: 10px;
      font-size: 28px;
      font-weight: 600;
    }
    .date-display {
      margin-bottom: 30px;
      color: var(--secondary-text);
      font-size: 14px;
    }

    /* --- NUEVO: ESTILOS DE MTRICAS (WIDGETS) --- */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }
    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
        display: flex;
        align-items: center;
        gap: 20px;
        transition: transform 0.2s;
        border-left: 5px solid var(--secondary-text); /* Color por defecto */
    }
    .stat-card:hover { transform: translateY(-3px); }
    
    /* Variantes de color para las tarjetas */
    .stat-card.sales { border-left-color: var(--success-color); }
    .stat-card.orders { border-left-color: var(--warning-color); }
    .stat-card.stock { border-left-color: var(--danger-color); }

    .stat-icon {
        font-size: 28px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #F4F6F7;
        color: var(--secondary-text);
    }
    .stat-card.sales .stat-icon { background-color: #EAFAF1; color: var(--success-color); }
    .stat-card.orders .stat-icon { background-color: #FEF9E7; color: var(--warning-color); }
    .stat-card.stock .stat-icon { background-color: #FADBD8; color: var(--danger-color); }

    .stat-info h3 { margin: 0; font-size: 14px; color: var(--secondary-text); text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-info p { margin: 5px 0 0; font-size: 26px; font-weight: 700; color: var(--primary-text); }
    .stat-info small { font-size: 12px; color: var(--secondary-text); }


    /* Grid de M贸dulos (Menu) */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 25px;
    }

    .dashboard-card {
      background: var(--card-bg);
      color: var(--primary-text);
      border-radius: 12px;
      padding: 25px;
      text-decoration: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 15px;
      box-shadow: var(--card-shadow);
      transition: transform 0.3s, box-shadow 0.3s;
      aspect-ratio: 1 / 1;
    }
    .dashboard-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
    }
    .dashboard-card i {
      font-size: 42px;
      color: var(--accent-color);
    }
    .dashboard-card span {
      font-size: 16px;
      font-weight: 500;
      text-align: center;
    }
    
    footer {
      text-align: center;
      padding: 20px;
      font-size: 14px;
      color: var(--secondary-text);
      margin-top: auto;
    }
  </style>
</head>
<body>
<header>
    <div class="logo">Olimpollo</div>
    <div class="user-info">
        <span id="user-identifier"></span>
        <button class="logout" id="btn-logout">Cerrar Sesi贸n</button>
    </div>
</header>

<main>
    <div>
        <h2 class="welcome-message" id="welcome-title">Bienvenido</h2>
        <p class="date-display" id="current-date">Cargando fecha...</p>
    </div>

    <div class="stats-container" id="stats-panel" style="display: none;">
        
        <div class="stat-card sales">
            <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
            <div class="stat-info">
                <h3>Ventas de Hoy</h3>
                <p id="stat-ventas">Cargando...</p>
                <small id="stat-pedidos-count">0 pedidos entregados</small>
            </div>
        </div>

        <div class="stat-card orders">
            <div class="stat-icon"><i class="fas fa-clock"></i></div>
            <div class="stat-info">
                <h3>Pendientes</h3>
                <p id="stat-pendientes">Cargando...</p>
                <small>En cocina o preparaci贸n</small>
            </div>
        </div>

        <div class="stat-card stock">
            <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <div class="stat-info">
                <h3>Stock Bajo</h3>
                <p id="stat-stock">Cargando...</p>
                <small>Insumos cr铆ticos</small>
            </div>
        </div>

    </div>

    <h3 style="margin-bottom: 20px; font-weight: 500;">M贸dulos de Gesti贸n</h3>
    <div class="dashboard-grid" id="panel-modulos">
        </div>
</main>

<footer>
    &copy; 2025 Los Boneless del Olimpo - Software de Gesti贸n
</footer>

<script>
    const API_URL = 'https://olimpollo-api.onrender.com/api';

    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        } catch (e) { return null; }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('authToken');
        const role = localStorage.getItem('userRole'); 
        
        if (!token || !role) {
            window.location.href = 'login.html';
            return;
        }

        const userData = parseJwt(token);
        const username = userData ? userData.username : 'Usuario';

        document.getElementById('user-identifier').textContent = username;
        document.getElementById('welcome-title').textContent = `Hola, ${username} `;

        // Mostrar fecha actual bonita
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('es-ES', options);

        const panel = document.getElementById('panel-modulos');
        
        // --- 1. DEFINICIN DE MDULOS (INCLUYENDO COMPRAS) ---
        const modulos = [
            { text: 'Nuevo Pedido (POS)', href: 'pedidos.html', roles: ['Administrador', 'Gerente', 'Empleado'], icon: 'fa-cash-register' },
            { text: 'Cocina (Comanda)', href: 'comanda.html', roles: ['Administrador', 'Gerente', 'Empleado'], icon: 'fa-receipt' },
            { text: 'Historial Pedidos', href: 'pedidos_lista.html', roles: ['Administrador', 'Gerente'], icon: 'fa-clipboard-list' },
            //  NUEVO MDULO DE COMPRAS AGREGADO:
            { text: 'Compras / Re-stock', href: 'compras.html', roles: ['Administrador', 'Gerente'], icon: 'fa-cart-shopping' },
            { text: 'Inventario', href: 'inventario.html', roles: ['Administrador', 'Gerente'], icon: 'fa-boxes-stacked' },
            { text: 'Reportes', href: 'reportes.html', roles: ['Administrador', 'Gerente'], icon: 'fa-chart-line' },
            { text: 'Recetas', href: 'recetas.html', roles: ['Administrador'], icon: 'fa-book-open' },
            { text: 'Men煤', href: 'menu_gestion.html', roles: ['Administrador'], icon: 'fa-utensils' },
            { text: 'Usuarios', href: 'usuarios.html', roles: ['Administrador'], icon: 'fa-users-cog' }
        ];
        
        // Renderizar M贸dulos
        modulos.forEach(mod => {
            if (mod.roles.includes(role)) {
                const link = document.createElement('a');
                link.href = mod.href;
                link.className = 'dashboard-card';
                link.innerHTML = `<i class="fas ${mod.icon}"></i><span>${mod.text}</span>`;
                panel.appendChild(link);
            }
        });

        // --- 2. LGICA DEL DASHBOARD (MTRICAS) ---
        // Solo cargamos m茅tricas si es Admin o Gerente para no saturar al Empleado
        if (role === 'Administrador' || role === 'Gerente') {
            document.getElementById('stats-panel').style.display = 'grid';
            cargarMetricas();
        }

        document.getElementById('btn-logout').addEventListener('click', () => {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userRole');
            window.location.href = 'login.html';
        });
    });

    async function cargarMetricas() {
        try {
            // A. Ventas de Hoy
            const hoy = new Date().toISOString().split('T')[0];
            const resVentas = await fetch(`${API_URL}/reportes/ventas?fechaInicio=${hoy}&fechaFin=${hoy}`);
            const dataVentas = await resVentas.json();
            
            document.getElementById('stat-ventas').textContent = `$${dataVentas.ventas_totales || '0.00'}`;
            document.getElementById('stat-pedidos-count').textContent = `${dataVentas.total_pedidos || 0} pedidos entregados`;

            // B. Pedidos Pendientes (Filtramos manualmente o usamos query si el backend lo soporta)
            // Asumimos que /pedidos trae los recientes. Filtramos en cliente para asegurar.
            const resPedidos = await fetch(`${API_URL}/pedidos?estado=Pendiente`); 
            // Nota: Si tu endpoint filtra, genial. Si devuelve todo, aqu铆 filtramos:
            let dataPedidos = await resPedidos.json();
            // Si el backend no filtra por query param, filtramos aqu铆:
            if(Array.isArray(dataPedidos)) {
                const pendientes = dataPedidos.filter(p => p.estado === 'Pendiente' || p.estado === 'En Preparaci贸n').length;
                document.getElementById('stat-pendientes').textContent = pendientes;
            } else {
                document.getElementById('stat-pendientes').textContent = '0';
            }

            // C. Stock Bajo
            const resStock = await fetch(`${API_URL}/inventario?estado=Requiere re-stock`);
            const dataStock = await resStock.json();
            // dataStock deber铆a ser un array con los items bajos de stock
            const stockBajoCount = Array.isArray(dataStock) ? dataStock.length : 0;
            
            const elemStock = document.getElementById('stat-stock');
            elemStock.textContent = stockBajoCount;
            if(stockBajoCount > 0) {
                elemStock.style.color = '#E74C3C'; // Rojo si hay alertas
            }

        } catch (error) {
            console.error("Error cargando dashboard:", error);
            // Fallback silencioso o mostrar '-'
            document.getElementById('stat-ventas').textContent = '-';
            document.getElementById('stat-pendientes').textContent = '-';
            document.getElementById('stat-stock').textContent = '-';
        }
    }
</script>
</body>
</html>
