<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Olimpollo - Reportes</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  
    <style>
        /* ==========================================================================
           BASE DE ESTILOS UNIFICADA PARA OLIMPOLLO
           ========================================================================== */
        :root{--bg-main:#ECF0F1;--bg-header:#FFFFFF;--card-bg:#FFFFFF;--primary-text:#502c2c;--secondary-text:#808B96;--accent-color:#db3434;--accent-hover:#b92929;--border-color:#D5D8DC;--shadow-light:0 4px 15px rgba(0, 0, 0, 0.08);--shadow-heavy:0 10px 20px rgba(0, 0, 0, 0.12);}body{margin:0;font-family:'Poppins', sans-serif;background-color:var(--bg-main);color:var(--primary-text);display:flex;flex-direction:column;min-height:100vh;}header{background:var(--bg-header);padding:15px 40px;box-shadow:0 2px 10px rgba(0, 0, 0, 0.05);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);}header .logo{font-size:24px;font-weight:600;text-decoration:none;color:var(--primary-text);}header nav{display:flex;gap:20px;}header nav a{text-decoration:none;color:var(--secondary-text);font-weight:500;transition:color 0.3s;}header nav a:hover{color:var(--accent-color);}.user-info{display:flex;align-items:center;gap:20px;}#user-identifier{font-weight:500;background-color:var(--bg-main);padding:5px 12px;border-radius:15px;font-size:14px;}.logout{background:var(--accent-color);color:white;border:none;padding:8px 18px;border-radius:20px;cursor:pointer;font-size:14px;font-weight:500;transition:background-color 0.3s;}.logout:hover{background-color:var(--accent-hover);}main{flex:1;padding:40px;max-width:1400px;margin:0 auto;width:100%;box-sizing:border-box;}h1, h2, h3{margin-top:0;}h2.page-title{margin-bottom:30px;font-size:28px;font-weight:600;}.card{background:var(--card-bg);border-radius:12px;padding:25px;box-shadow:var(--shadow-light);margin-bottom:25px;}table{width:100%;border-collapse:collapse;background:var(--card-bg);border-radius:12px;overflow:hidden;box-shadow:var(--shadow-light);}th, td{padding:15px;text-align:left;border-bottom:1px solid var(--bg-main);}th{font-weight:600;font-size:14px;text-transform:uppercase;color:var(--secondary-text);background-color:#F8F9F9;}tr:hover{background-color:#FDF2F2;}.btn{border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:500;font-family:'Poppins', sans-serif;transition:background-color 0.3s, transform 0.2s;}.btn:hover{transform:translateY(-2px);}.btn-primary{background-color:var(--accent-color);color:white;}.btn-primary:hover{background-color:var(--accent-hover);}.btn-secondary{background-color:var(--secondary-text);color:white;}.btn-secondary:hover{background-color:#6C7A89;}.btn-danger{background-color:#E74C3C;color:white;}.btn-success{background-color:#2ECC71;color:white;}label{display:block;margin-bottom:8px;font-weight:500;font-size:14px;}input[type="text"],input[type="password"],input[type="number"],input[type="date"],select,textarea{width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;font-family:'Poppins', sans-serif;font-size:14px;box-sizing:border-box;transition:border-color 0.3s, box-shadow 0.3s;}input:focus, select:focus, textarea:focus{outline:none;border-color:var(--accent-color);box-shadow:0 0 0 3px rgba(219, 52, 52, 0.1);}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);justify-content:center;align-items:center;}.modal-content{background:var(--card-bg);padding:30px;border-radius:12px;box-shadow:var(--shadow-heavy);width:90%;max-width:500px;position:relative;}.close{position:absolute;top:15px;right:20px;font-size:28px;cursor:pointer;color:var(--secondary-text);}footer{text-align:center;padding:20px;font-size:14px;color:var(--secondary-text);}
    
        /* Estilos espec√≠ficos para esta p√°gina */
        .filtros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: flex-end;
        }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">Olimpollo</a>
        <nav>
          <a href="pedidos.html">POS</a>
          <a href="reportes.html">Reportes</a>
          <a href="pedidos_lista.html">Pedidos</a>
          <a href="inventario.html">Inventario</a>
        </nav>
        <div class="user-info">
            <span id="user-identifier"></span>
            <button class="logout" id="btn-logout">Cerrar Sesi√≥n</button>
        </div>
    </header>

    <main>
        <h2 class="page-title">Generador de Reportes</h2>

        <div class="card">
            <div class="filtros-grid">
                <div>
                    <label for="select-tipo-reporte">Tipo de Reporte:</label>
                    <select id="select-tipo-reporte">
                        <option value="">Seleccionar Tipo</option>
                        <option value="semanal_gerencial">‚≠ê Resumen Semanal Gerencial</option>
                        <option value="ventas">Reporte de Ventas</option>
                        <option value="historico_inventario">Inventario Hist√≥rico</option>
                        <option value="platillos">Conteo de Platillos</option>
                        <option value="insumos_teoricos">Uso de Insumos (Te√≥rico)</option>
                    </select>
                </div>
                <div>
                    <label for="fechaInicio">Fecha Inicio / Fecha √önica:</label>
                    <input type="date" id="fechaInicio">
                </div>
                <div>
                    <label for="fechaFin">Fecha Fin:</label>
                    <input type="date" id="fechaFin">
                </div>
                <div>
                    <button id="btn-generar" class="btn btn-primary" style="width: 100%;">Generar Reporte</button>
                </div>
            </div>
            <p id="mensaje-reporte" style="margin-top: 15px; text-align: center;"></p>
        </div>

        <div id="resultados-reporte" class="card" style="display: none;">
            </div>
    </main>

    <footer>
        &copy; 2025 Los Boneless del Olimpo
    </footer>

<script>
        // Funci√≥n para decodificar el token JWT
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = 'https://olimpollo-api.onrender.com/api/reportes'; // Endpoint base
            const API_BASE = 'https://olimpollo-api.onrender.com/api'; // Base general
            
            // --- 1. VERIFICACI√ìN DE LOGIN Y USUARIO ---
            const token = localStorage.getItem('authToken');
            const role = localStorage.getItem('userRole');

            if (!token || !role) {
                window.location.href = 'login.html';
                return;
            }

            // Permitir acceso a Administradores y Gerentes
            if (role !== 'Administrador' && role !== 'Gerente') {
                alert('Acceso denegado: No tiene permisos para ver reportes.');
                window.location.href = 'index.html';
            }

            const userData = parseJwt(token);
            if (userData && userData.username) {
                document.getElementById('user-identifier').textContent = userData.username;
            }

            document.getElementById('btn-logout').addEventListener('click', () => {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userRole');
                window.location.href = 'login.html';
            });
            
            // --- 2. ELEMENTOS DEL DOM ---
            const botonGenerar = document.getElementById('btn-generar');
            const mensajeElemento = document.getElementById('mensaje-reporte');
            const inputFechaInicio = document.getElementById('fechaInicio');
            const inputFechaFin = document.getElementById('fechaFin');
            const selectTipoReporte = document.getElementById('select-tipo-reporte');
            const resultadosDiv = document.getElementById('resultados-reporte'); 
            
            // --- 3. FUNCIONES DE REPORTES ---

            // A. REPORTE HIST√ìRICO DE INVENTARIO
            const generarReporteHistorico = async (fecha) => {
                resultadosDiv.innerHTML = '<h4>Cargando registros...</h4>';
                resultadosDiv.style.display = 'block';
                
                try {
                    const url = `${API_URL}/inventario?fecha=${fecha}`;
                    const response = await fetch(url);
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.mensaje || 'Error al generar reporte hist√≥rico');
                    }
                    
                    let tablaHTML = `
                        <h4>Inventario Registrado el ${fecha}</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>Insumo</th>
                                    <th>Cantidad</th>
                                    <th>Unidad</th>
                                    <th>Categor√≠a</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    
                    data.forEach(item => {
                        tablaHTML += `
                            <tr>
                                <td>${item.nombre_insumo}</td>
                                <td>${item.cantidad_registrada}</td>
                                <td>${item.unidad_medida}</td>
                                <td>${item.categoria}</td>
                            </tr>`;
                    });
                    tablaHTML += `</tbody></table>`;
                    
                    resultadosDiv.innerHTML = tablaHTML;
                    mensajeElemento.textContent = 'Reporte hist√≥rico generado exitosamente.';
                    mensajeElemento.style.color = 'green';
                } catch (error) {
                    resultadosDiv.innerHTML = `<p style="color:red; font-weight:bold;">${error.message}</p>`;
                }
            };
            
            // B. REPORTE DE VENTAS
            const generarReporteVentas = async (fechaInicio, fechaFin) => {
                resultadosDiv.innerHTML = '<h4>Calculando ventas y comisiones...</h4>';
                resultadosDiv.style.display = 'block';

                const url = `${API_URL}/ventas?fechaInicio=${fechaInicio}&fechaFin=${fechaFin}`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();

                    if (!response.ok) throw new Error(data.error || 'Error desconocido al generar reporte');
                    
                    // Totales
                    const ventasBrutas = parseFloat(data.ventas_totales || 0);
                    const comisiones = parseFloat(data.comisiones || 0);
                    const ingresoNeto = ventasBrutas - comisiones;

                    resultadosDiv.innerHTML = `
                        <h4>Resultados del Reporte de Ventas</h4>
                        <div style="padding: 20px; background: #f4f6f7; border-radius: 8px;">
                            <p><strong>Periodo:</strong> ${data.fechaInicio} al ${data.fechaFin}</p>
                            <p><strong>Total de Pedidos Entregados:</strong> ${data.total_pedidos}</p>
                            <hr>
                            
                            <p style="font-size: 1.1em;">
                                <strong>Venta Bruta (P√∫blico):</strong> 
                                <span>$${ventasBrutas.toFixed(2)}</span>
                            </p>
                            
                            ${comisiones > 0 ? `
                                <p style="font-size: 1.1em; color: #e74c3c;">
                                    <strong>- Comisiones (Apps/Terminal):</strong> 
                                    <span>$${comisiones.toFixed(2)}</span>
                                </p>
                            ` : ''}
                            
                            <hr>
                            
                            <p style="font-size: 1.6em; margin-top: 10px;">
                                <strong>Ingreso Neto Real:</strong> 
                                <span style="color: #27AE60;">$${ingresoNeto.toFixed(2)}</span>
                            </p>
                        </div>`;
                    mensajeElemento.textContent = 'Reporte generado exitosamente.';
                    mensajeElemento.style.color = 'green';
                } catch (error) {
                    resultadosDiv.innerHTML = `<p style="color:red; font-weight:bold;">${error.message}</p>`;
                }
            };

            // C. REPORTE DE PLATILLOS (POPULARIDAD)
            const generarReportePlatillos = async (fechaInicio, fechaFin) => {
                resultadosDiv.innerHTML = '<h4>Analizando popularidad...</h4>';
                resultadosDiv.style.display = 'block';

                const url = `${API_URL}/platillos?fechaInicio=${fechaInicio}&fechaFin=${fechaFin}`;
                
                try {
                    const response = await fetch(url);
                    const data = await response.json();

                    if (!response.ok) throw new Error(data.error || 'Error al obtener datos');

                    if (data.length === 0) {
                        resultadosDiv.innerHTML = '<p>No hay ventas registradas en este periodo.</p>';
                        return;
                    }

                    let html = `
                        <h4>Popularidad de Platillos (${fechaInicio} al ${fechaFin})</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th style="text-align:center">Posici√≥n</th>
                                    <th>Producto Base</th>
                                    <th>Cantidad Vendida</th>
                                    <th>Ingresos Generados</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    data.forEach((item, index) => {
                        let rango = `#${index + 1}`;
                        let rowStyle = "";
                        if (index === 0) { rango = 'ü•á'; rowStyle = "background-color: #fff9c4;"; }
                        if (index === 1) { rango = 'ü•à'; rowStyle = "background-color: #f5f5f5;"; }
                        if (index === 2) { rango = 'ü•â'; rowStyle = "background-color: #ffe0b2;"; }

                        html += `
                            <tr style="${rowStyle}">
                                <td style="font-weight:bold; text-align:center; font-size: 1.2em;">${rango}</td>
                                <td style="font-weight:500;">${item.producto}</td>
                                <td style="font-weight:bold; color: var(--accent-color);">${item.cantidad_vendida}</td>
                                <td>$${parseFloat(item.ingreso_generado).toFixed(2)}</td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';
                    resultadosDiv.innerHTML = html;
                    mensajeElemento.textContent = 'Reporte de popularidad generado.';
                    mensajeElemento.style.color = 'green';

                } catch (error) {
                    resultadosDiv.innerHTML = `<p style="color:red; font-weight:bold;">${error.message}</p>`;
                }
            };

            // D. REPORTE DE INSUMOS TE√ìRICOS
            const generarReporteInsumosTeoricos = async (fechaInicio, fechaFin) => {
                resultadosDiv.innerHTML = '<h4>Calculando consumo de recetas...</h4>';
                resultadosDiv.style.display = 'block';

                const url = `${API_URL}/insumos-teoricos?fechaInicio=${fechaInicio}&fechaFin=${fechaFin}`;
                
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Error al obtener datos');

                    if (data.length === 0) {
                        resultadosDiv.innerHTML = '<p>No se encontraron datos. Aseg√∫rate de tener recetas configuradas.</p>';
                        return;
                    }

                    let html = `
                        <h4>Uso Te√≥rico de Insumos (${fechaInicio} al ${fechaFin})</h4>
                        <p style="font-size:0.9em; color:gray; margin-bottom:15px;">* Consumo basado en recetas de lo vendido.</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>Insumo</th>
                                    <th>Cantidad Te√≥rica</th>
                                    <th>Unidad</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    data.forEach(item => {
                        html += `
                            <tr>
                                <td style="font-weight:500;">${item.nombre_insumo}</td>
                                <td style="font-weight:bold; color: #E67E22;">${Number(item.cantidad_total).toFixed(2)}</td>
                                <td>${item.unidad}</td>
                            </tr>`;
                    });
                    html += '</tbody></table>';
                    resultadosDiv.innerHTML = html;
                    mensajeElemento.textContent = 'C√°lculo completado.';
                    mensajeElemento.style.color = 'green';
                } catch (error) {
                    resultadosDiv.innerHTML = `<p style="color:red; font-weight:bold;">${error.message}</p>`;
                }
            };

            // E. REPORTE SEMANAL GERENCIAL (NUEVO) üìä
            const generarReporteSemanal = async (fechaInicio, fechaFin) => {
                resultadosDiv.innerHTML = '<h4 style="text-align:center;">Generando an√°lisis de negocio... üìä</h4>';
                resultadosDiv.style.display = 'block';

                // Nota: Apunta al endpoint correcto (usando API_BASE por comodidad o API_URL/semanal)
                const url = `${API_URL}/semanal?fechaInicio=${fechaInicio}&fechaFin=${fechaFin}`;
                
                try {
                    const response = await fetch(url);
                    const data = await response.json();

                    if (!response.ok) throw new Error(data.error || 'Error al generar reporte gerencial');

                    const f = data.financiero;
                    
                    // Estructura HTML del Reporte
                    let html = `
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h2 style="color: var(--primary-text); margin:0;">Resumen Semanal Olimpollo</h2>
                            <small>Periodo: ${fechaInicio} al ${fechaFin}</small>
                        </div>

                        <div style="display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;">
                            <div style="flex:1; background: #e8f8f5; padding: 15px; border-radius: 10px; border-left: 5px solid #2ecc71;">
                                <small>Venta Bruta Total</small>
                                <div style="font-size: 24px; font-weight: bold;">$${f.total_bruto.toFixed(2)}</div>
                            </div>
                            <div style="flex:1; background: #fdedec; padding: 15px; border-radius: 10px; border-left: 5px solid #e74c3c;">
                                <small>Comisiones (Apps/Tarjeta)</small>
                                <div style="font-size: 24px; font-weight: bold; color: #c0392b;">-$${f.total_comisiones.toFixed(2)}</div>
                            </div>
                            <div style="flex:1; background: #2c3e50; color: white; padding: 15px; border-radius: 10px; border-left: 5px solid #f1c40f;">
                                <small style="color: #bdc3c7;">Ingreso Neto Real</small>
                                <div style="font-size: 24px; font-weight: bold;">$${f.total_neto.toFixed(2)}</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 30px;">
                            <h3 style="border-bottom: 2px solid #ddd; padding-bottom: 5px;">üì± Desglose de Aplicaciones</h3>
                            <table style="width: 100%; margin-top: 10px;">
                                <tr style="background: #f8f9fa;">
                                    <th>Plataforma</th>
                                    <th>Venta Bruta</th>
                                    <th>% del Total</th>
                                </tr>
                                ${Object.keys(f.apps_detalle).length > 0 ? 
                                    Object.keys(f.apps_detalle).map(app => `
                                    <tr>
                                        <td>${app}</td>
                                        <td>$${f.apps_detalle[app].toFixed(2)}</td>
                                        <td>${((f.apps_detalle[app] / f.total_bruto) * 100).toFixed(1)}%</td>
                                    </tr>
                                `).join('') 
                                : '<tr><td colspan="3">No hubo ventas por Apps en este periodo.</td></tr>'}
                            </table>
                        </div>

                        <div style="margin-bottom: 30px;">
                            <h3 style="border-bottom: 2px solid #ddd; padding-bottom: 5px; display:flex; justify-content:space-between;">
                                üõí Lista de Compras Sugerida
                                <span style="font-size: 14px; background: #f1c40f; padding: 2px 8px; border-radius: 4px; color: black;">
                                    Costo Est: $${data.costo_estimado_resurtido}
                                </span>
                            </h3>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                                ${Object.keys(data.compras).length > 0 ? 
                                    Object.keys(data.compras).map(proveedor => `
                                    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
                                        <div style="background: #34495e; color: white; padding: 8px 15px; font-weight: bold;">
                                            üè™ ${proveedor}
                                        </div>
                                        <ul style="list-style: none; padding: 0; margin: 0;">
                                            ${data.compras[proveedor].map(item => `
                                                <li style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                                    <div>
                                                        <span style="font-weight: 500;">${item.nombre}</span><br>
                                                        <small style="color: gray;">Stock: ${item.stock_actual} (Min: ${item.minimo})</small>
                                                    </div>
                                                    <div style="text-align: right;">
                                                        <span style="font-weight: bold; color: var(--accent-color); font-size: 1.1em;">${item.pedir}</span><br>
                                                        <small style="font-size: 10px;">${item.estado}</small>
                                                    </div>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                `).join('') 
                                : '<p style="text-align:center; color:green; width:100%;">‚úÖ Todo el inventario est√° saludable. No se requieren compras urgentes.</p>'}
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 40px;">
                            <button onclick="window.print()" class="btn btn-secondary">üñ®Ô∏è Imprimir Reporte Semanal</button>
                        </div>
                    `;

                    resultadosDiv.innerHTML = html;
                    mensajeElemento.textContent = 'Resumen gerencial generado.';
                    mensajeElemento.style.color = 'green';

                } catch (error) {
                    resultadosDiv.innerHTML = `<p style="color:red; font-weight:bold;">${error.message}</p>`;
                }
            };
            
            // --- 4. MANEJADOR DE EVENTOS (BOT√ìN GENERAR) ---
            botonGenerar.addEventListener('click', () => {
                const tipoReporte = selectTipoReporte.value;
                const fechaInicio = inputFechaInicio.value;
                const fechaFin = inputFechaFin.value;

                mensajeElemento.textContent = '';
                resultadosDiv.style.display = 'none';

                if (!tipoReporte) {
                    mensajeElemento.textContent = 'Por favor, selecciona el tipo de reporte.';
                    mensajeElemento.style.color = 'red';
                    return;
                }

                if (tipoReporte === 'semanal_gerencial') { // NUEVO
                    if (!fechaInicio || !fechaFin) {
                        mensajeElemento.textContent = 'Selecciona el rango de fechas (ej: Lunes a Domingo).';
                        mensajeElemento.style.color = 'red';
                        return;
                    }
                    generarReporteSemanal(fechaInicio, fechaFin);
                
                } else if (tipoReporte === 'ventas') {
                    if (!fechaInicio || !fechaFin) {
                        mensajeElemento.textContent = 'Selecciona fecha inicio y fin.';
                        mensajeElemento.style.color = 'red';
                        return;
                    }
                    generarReporteVentas(fechaInicio, fechaFin);
                
                } else if (tipoReporte === 'platillos') {
                    if (!fechaInicio || !fechaFin) {
                        mensajeElemento.textContent = 'Selecciona fecha inicio y fin.';
                        mensajeElemento.style.color = 'red';
                        return;
                    }
                    generarReportePlatillos(fechaInicio, fechaFin);

                } else if (tipoReporte === 'insumos_teoricos') { 
                    if (!fechaInicio || !fechaFin) {
                        mensajeElemento.textContent = 'Selecciona fecha inicio y fin.';
                        mensajeElemento.style.color = 'red';
                        return;
                    }
                    generarReporteInsumosTeoricos(fechaInicio, fechaFin);

                } else if (tipoReporte === 'historico_inventario') {
                    if (!fechaInicio) {
                        mensajeElemento.textContent = 'Selecciona la fecha de registro.';
                        mensajeElemento.style.color = 'red';
                        return;
                    }
                    generarReporteHistorico(fechaInicio);
                }
                
                setTimeout(() => { mensajeElemento.textContent = ''; }, 5000);
            });
        });
    </script>
</body>
</html>
