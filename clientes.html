<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Olimpollo - Clientes (CRM)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* ==========================================================================
           BASE DE ESTILOS UNIFICADA PARA OLIMPOLLO
           ========================================================================== */
        :root{--bg-main:#ECF0F1;--bg-header:#FFFFFF;--card-bg:#FFFFFF;--primary-text:#502c2c;--secondary-text:#808B96;--accent-color:#db3434;--accent-hover:#b92929;--border-color:#D5D8DC;--shadow-light:0 4px 15px rgba(0, 0, 0, 0.08);--shadow-heavy:0 10px 20px rgba(0, 0, 0, 0.12);}body{margin:0;font-family:'Poppins', sans-serif;background-color:var(--bg-main);color:var(--primary-text);display:flex;flex-direction:column;min-height:100vh;}header{background:var(--bg-header);padding:15px 40px;box-shadow:0 2px 10px rgba(0, 0, 0, 0.05);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);}header .logo{font-size:24px;font-weight:600;text-decoration:none;color:var(--primary-text);}header nav{display:flex;gap:20px;}header nav a{text-decoration:none;color:var(--secondary-text);font-weight:500;transition:color 0.3s;}header nav a:hover{color:var(--accent-color);}.user-info{display:flex;align-items:center;gap:20px;}#user-identifier{font-weight:500;background-color:var(--bg-main);padding:5px 12px;border-radius:15px;font-size:14px;}.logout{background:var(--accent-color);color:white;border:none;padding:8px 18px;border-radius:20px;cursor:pointer;font-size:14px;font-weight:500;transition:background-color 0.3s;}.logout:hover{background-color:var(--accent-hover);}main{flex:1;padding:40px;max-width:1400px;margin:0 auto;width:100%;box-sizing:border-box;}h1, h2, h3{margin-top:0;}h2.page-title{margin-bottom:30px;font-size:28px;font-weight:600;}.card{background:var(--card-bg);border-radius:12px;padding:25px;box-shadow:var(--shadow-light);margin-bottom:25px;}table{width:100%;border-collapse:collapse;background:var(--card-bg);border-radius:12px;overflow:hidden;box-shadow:var(--shadow-light);}th, td{padding:15px;text-align:left;border-bottom:1px solid var(--bg-main);}th{font-weight:600;font-size:14px;text-transform:uppercase;color:var(--secondary-text);background-color:#F8F9F9;}tr:hover{background-color:#FDF2F2;}.btn{border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:500;font-family:'Poppins', sans-serif;transition:background-color 0.3s, transform 0.2s;}.btn:hover{transform:translateY(-2px);}.btn-primary{background-color:var(--accent-color);color:white;}.btn-primary:hover{background-color:var(--accent-hover);}.btn-secondary{background-color:var(--secondary-text);color:white;}.btn-secondary:hover{background-color:#6C7A89;}label{display:block;margin-bottom:8px;font-weight:500;font-size:14px;}input[type="text"],input[type="password"],input[type="number"],input[type="date"],select,textarea{width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;font-family:'Poppins', sans-serif;font-size:14px;box-sizing:border-box;transition:border-color 0.3s, box-shadow 0.3s;}input:focus, select:focus, textarea:focus{outline:none;border-color:var(--accent-color);box-shadow:0 0 0 3px rgba(219, 52, 52, 0.1);}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);justify-content:center;align-items:center;}.modal-content{background:var(--card-bg);padding:30px;border-radius:12px;box-shadow:var(--shadow-heavy);width:90%;max-width:400px;position:relative;}.close{position:absolute;top:15px;right:20px;font-size:28px;cursor:pointer;color:var(--secondary-text);}footer{text-align:center;padding:20px;font-size:14px;color:var(--secondary-text);}

        /* Buscador */
        .search-container { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-container input { flex: 1; font-size: 16px; padding: 15px; }
        
        /* Highlight VIPs */
        .vip-badge { background-color: #f1c40f; color: #8a6d3b; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-left: 10px;}
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">Olimpollo</a>
        <nav>
            <a href="pedidos.html">POS</a>
            <a href="pedidos_lista.html">Pedidos</a>
            <a href="clientes.html" style="color: var(--accent-color);">Clientes</a>
            <a href="inventario.html">Inventario</a>
            <a href="reportes.html">Reportes</a>
        </nav>
        <div class="user-info">
            <span id="user-identifier"></span>
            <button class="logout" id="btn-logout">Cerrar Sesi√≥n</button>
        </div>
    </header>

    <main>
        <h2 class="page-title">Directorio de Clientes (CRM)</h2>
        
        <div class="card">
            <div class="search-container">
                <input type="text" id="buscador" placeholder="üîç Buscar por nombre o n√∫mero de tel√©fono..." autocomplete="off">
                <button id="btn-buscar" class="btn btn-primary">Buscar</button>
            </div>
            
            <table id="tabla-clientes">
                <thead>
                    <tr>
                        <th>Tel√©fono</th>
                        <th>Nombre</th>
                        <th style="text-align:center;">Visitas</th>
                        <th style="text-align:center;">Puntos</th>
                        <th>Total Invertido</th>
                        <th>√öltima Visita</th>
                        <th>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="tabla-clientes-body">
                    <tr><td colspan="7" style="text-align: center;">Cargando clientes...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <div id="modalEditar" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Modificar Cliente</h3>
            <p style="font-size: 13px; color: gray;">Actualiza el nombre del cliente. El tel√©fono no se puede modificar ya que es su identificador √∫nico.</p>
            <form id="form-editar" style="display: grid; gap: 15px; margin-top: 15px;">
                <input type="hidden" id="edit-id">
                
                <div>
                    <label>Tel√©fono:</label>
                    <input type="text" id="edit-telefono" disabled style="background-color: #f4f6f7;">
                </div>
                <div>
                    <label for="edit-nombre">Nombre del Cliente:</label>
                    <input type="text" id="edit-nombre" required placeholder="Ej: Juan P√©rez">
                </div>
                
                <button type="submit" class="btn btn-primary" style="margin-top: 10px;">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <footer>&copy; 2025 Los Boneless del Olimpo</footer>

    <script>
        // Funci√≥n para decodificar JWT
        function parseJwt(token) { try { const base64Url = token.split('.')[1]; const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/'); const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); return JSON.parse(jsonPayload); } catch (e) { return null; } }

        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = 'https://olimpollo-api.onrender.com/api/clientes';
            
            // Verificaci√≥n de sesi√≥n
            const token = localStorage.getItem('authToken');
            if (!token) { window.location.href = 'login.html'; return; }
            
            const userData = parseJwt(token);
            if (userData && userData.username) { document.getElementById('user-identifier').textContent = userData.username; }
            
            document.getElementById('btn-logout').addEventListener('click', () => {
                localStorage.removeItem('authToken'); localStorage.removeItem('userRole'); window.location.href = 'login.html';
            });

            // Elementos DOM
            const tablaBody = document.getElementById('tabla-clientes-body');
            const buscador = document.getElementById('buscador');
            const btnBuscar = document.getElementById('btn-buscar');
            
            const modalEditar = document.getElementById('modalEditar');
            const formEditar = document.getElementById('form-editar');
            const editId = document.getElementById('edit-id');
            const editTelefono = document.getElementById('edit-telefono');
            const editNombre = document.getElementById('edit-nombre');

            // 1. CARGAR Y RENDERIZAR CLIENTES
            const cargarClientes = async (queryBusqueda = '') => {
                try {
                    tablaBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Cargando...</td></tr>';
                    
                    const url = queryBusqueda ? `${API_URL}?buscar=${encodeURIComponent(queryBusqueda)}` : API_URL;
                    const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                    
                    if (!response.ok) throw new Error('Error al obtener la lista de clientes');
                    
                    const clientes = await response.json();
                    tablaBody.innerHTML = '';

                    if (clientes.length === 0) {
                        tablaBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: gray;">No se encontraron clientes.</td></tr>';
                        return;
                    }

                    clientes.forEach(c => {
                        const tr = document.createElement('tr');
                        
                        // Formatear Fecha
                        let fechaVisita = 'Nunca';
                        if (c.ultima_visita) {
                            const dateObj = new Date(c.ultima_visita);
                            fechaVisita = dateObj.toLocaleDateString('es-MX') + ' ' + dateObj.toLocaleTimeString('es-MX', {hour: '2-digit', minute:'2-digit'});
                        }

                        // Etiqueta VIP para clientes con m√°s de 10 visitas (Puedes cambiar el n√∫mero)
                        const vipBadge = parseInt(c.visitas) >= 5 ? '<span class="vip-badge">‚≠ê Frecuente</span>' : '';

                        tr.innerHTML = `
                            <td style="font-weight:600;">${c.telefono}</td>
                            <td>${c.nombre || 'Sin Nombre'} ${vipBadge}</td>
                            <td style="text-align:center; font-weight:bold; color:var(--accent-color);">${c.visitas}</td>
                            <td style="text-align:center; font-weight:bold; color:#27ae60;">${c.puntos}</td>
                            <td>$${parseFloat(c.total_gastado || 0).toFixed(2)}</td>
                            <td><small>${fechaVisita}</small></td>
                            <td>
                                <button class="btn btn-secondary btn-editar" 
                                        data-id="${c.id}" 
                                        data-nombre="${c.nombre || ''}" 
                                        data-telefono="${c.telefono}">
                                    ‚úèÔ∏è Editar
                                </button>
                            </td>
                        `;
                        tablaBody.appendChild(tr);
                    });

                } catch (error) {
                    console.error('Error:', error);
                    tablaBody.innerHTML = `<tr><td colspan="7" style="color:red; text-align:center;">Error: ${error.message}</td></tr>`;
                }
            };

            // 2. BUSCADOR
            btnBuscar.addEventListener('click', () => cargarClientes(buscador.value));
            buscador.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') cargarClientes(buscador.value);
                // Si borran todo, recargar lista completa
                if (buscador.value === '') cargarClientes();
            });

            // 3. ABRIR MODAL PARA EDITAR
            tablaBody.addEventListener('click', (e) => {
                const btn = e.target.closest('.btn-editar');
                if (btn) {
                    editId.value = btn.dataset.id;
                    editTelefono.value = btn.dataset.telefono;
                    editNombre.value = btn.dataset.nombre;
                    modalEditar.style.display = 'flex';
                    editNombre.focus();
                }
            });

            // 4. GUARDAR CAMBIOS DE NOMBRE
            formEditar.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = editId.value;
                const nuevoNombre = editNombre.value.trim();

                try {
                    const response = await fetch(`${API_URL}/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ nombre: nuevoNombre })
                    });

                    if (!response.ok) throw new Error('Error al actualizar el cliente');
                    
                    // Cerrar modal y recargar lista conservando la b√∫squeda actual
                    modalEditar.style.display = 'none';
                    cargarClientes(buscador.value);
                    
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            });

            // 5. CERRAR MODAL
            document.querySelector('.close').addEventListener('click', () => modalEditar.style.display = 'none');
            window.addEventListener('click', (e) => { if (e.target === modalEditar) modalEditar.style.display = 'none'; });

            // Inicializar
            cargarClientes();
        });
    </script>
</body>
</html>
