<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Olimpollo - Lista de Pedidos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  
  <style>
    /* ==========================================================================
       BASE DE ESTILOS UNIFICADA PARA OLIMPOLLO
       ========================================================================== */
    :root{--bg-main:#ECF0F1;--bg-header:#FFFFFF;--card-bg:#FFFFFF;--primary-text:#502c2c;--secondary-text:#808B96;--accent-color:#db3434;--accent-hover:#b92929;--border-color:#D5D8DC;--shadow-light:0 4px 15px rgba(0, 0, 0, 0.08);--shadow-heavy:0 10px 20px rgba(0, 0, 0, 0.12);}body{margin:0;font-family:'Poppins', sans-serif;background-color:var(--bg-main);color:var(--primary-text);display:flex;flex-direction:column;min-height:100vh;}header{background:var(--bg-header);padding:15px 40px;box-shadow:0 2px 10px rgba(0, 0, 0, 0.05);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);}header .logo{font-size:24px;font-weight:600;text-decoration:none;color:var(--primary-text);}header nav{display:flex;gap:20px;}header nav a{text-decoration:none;color:var(--secondary-text);font-weight:500;transition:color 0.3s;}header nav a:hover{color:var(--accent-color);}.user-info{display:flex;align-items:center;gap:20px;}#user-identifier{font-weight:500;background-color:var(--bg-main);padding:5px 12px;border-radius:15px;font-size:14px;}.logout{background:var(--accent-color);color:white;border:none;padding:8px 18px;border-radius:20px;cursor:pointer;font-size:14px;font-weight:500;transition:background-color 0.3s;}.logout:hover{background-color:var(--accent-hover);}main{flex:1;padding:40px;max-width:1400px;margin:0 auto;width:100%;box-sizing:border-box;}h1, h2, h3{margin-top:0;}h2.page-title{margin-bottom:30px;font-size:28px;font-weight:600;}.card{background:var(--card-bg);border-radius:12px;padding:25px;box-shadow:var(--shadow-light);margin-bottom:25px;}table{width:100%;border-collapse:collapse;background:var(--card-bg);border-radius:12px;overflow:hidden;box-shadow:var(--shadow-light);}th, td{padding:15px;text-align:left;border-bottom:1px solid var(--bg-main);}th{font-weight:600;font-size:14px;text-transform:uppercase;color:var(--secondary-text);background-color:#F8F9F9;}tr:hover{background-color:#FDF2F2;}.btn{border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:500;font-family:'Poppins', sans-serif;transition:background-color 0.3s, transform 0.2s;}.btn:hover{transform:translateY(-2px);}.btn-primary{background-color:var(--accent-color);color:white;}.btn-primary:hover{background-color:var(--accent-hover);}.btn-secondary{background-color:var(--secondary-text);color:white;}.btn-secondary:hover{background-color:#6C7A89;}.btn-danger{background-color:#E74C3C;color:white;}.btn-success{background-color:#2ECC71;color:white;}label{display:block;margin-bottom:8px;font-weight:500;font-size:14px;}input[type="text"],input[type="password"],input[type="number"],input[type="date"],select,textarea{width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;font-family:'Poppins', sans-serif;font-size:14px;box-sizing:border-box;transition:border-color 0.3s, box-shadow 0.3s;}input:focus, select:focus, textarea:focus{outline:none;border-color:var(--accent-color);box-shadow:0 0 0 3px rgba(219, 52, 52, 0.1);}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);justify-content:center;align-items:center;}.modal-content{background:var(--card-bg);padding:30px;border-radius:12px;box-shadow:var(--shadow-heavy);width:90%;max-width:500px;position:relative;}.close{position:absolute;top:15px;right:20px;font-size:28px;cursor:pointer;color:var(--secondary-text);}footer{text-align:center;padding:20px;font-size:14px;color:var(--secondary-text);}

    /* Estilos espec칤ficos para esta p치gina */
    .layout-container { display: flex; gap: 25px; flex-wrap: wrap; }
    .pedidos-lista { flex: 3; min-width: 450px; }
    .detalles { flex: 1; min-width: 300px; align-self: flex-start; }
    .detalles ul { list-style: none; padding: 0; }
    .filtros-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; align-items: flex-end; }
  </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">Olimpollo</a>
        <nav>
          <a href="pedidos.html">POS</a>
          <a href="reportes.html">Reportes</a>
          <a href="pedidos_lista.html">Pedidos</a>
          <a href="inventario.html">Inventario</a>
          <a href="recetas.html">Recetas</a>
        </nav>
        <div class="user-info">
            <span id="user-identifier"></span>
            <button class="logout" id="btn-logout">Cerrar Sesi칩n</button>
        </div>
    </header>

  <main>
    <h2 class="page-title">Historial de 칍rdenes</h2>
    
    <div class="card">
        <div class="filtros-grid">
            <div>
                <label for="filtro-canal">Filtrar por Canal:</label>
                <select id="filtro-canal">
                    <option value="Todos">Todos los Canales</option>
                    <option value="OyR">OyR</option>
                    <option value="Uber">Uber</option>
                    <option value="Didi">Didi</option>
                    <option value="Rappi">Rappi</option>
                    <option value="Empleado">Empleado</option>
                </select>
            </div>
            <div>
                <label for="filtro-fecha-inicio">Desde:</label>
                <input type="date" id="filtro-fecha-inicio">
            </div>
            <div>
                <label for="filtro-fecha-fin">Hasta:</label>
                <input type="date" id="filtro-fecha-fin">
            </div>
            <button id="btn-aplicar-filtro" class="btn btn-primary">Aplicar Filtro</button>
        </div>
    </div>
    
    <div class="layout-container">
      <div class="pedidos-lista">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Canal</th>
                    <th>Cliente</th>
                    <th>Estado</th>
                    <th>Total</th>
                    <th>Fecha</th> <th>Hora</th>
                    <th>Acciones</th> </tr>
            </thead>
            <tbody id="tabla-pedidos-body"></tbody>
        </table>
      </div>

      <div class="detalles card">
          <h3 id="detalle-titulo">Detalles del Pedido</h3>
          <div id="detalle-contenido"><p>Selecciona un pedido para ver sus detalles.</p></div>
          <div id="panel-acciones" style="margin-top: 20px;"></div>
      </div>
    </div>
  </main>

  <footer>&copy; 2025 Los Boneless del Olimpo</footer>

<script>
// Funci칩n para decodificar JWT
function parseJwt(token) { try { const base64Url = token.split('.')[1]; const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/'); const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); return JSON.parse(jsonPayload); } catch (e) { return null; } }

document.addEventListener('DOMContentLoaded', () => {

    const API_PEDIDOS_URL = 'https://olimpollo-api.onrender.com/api/pedidos';
    const tablaBody = document.getElementById('tabla-pedidos-body');
    const detalleContenido = document.getElementById('detalle-contenido');
    const panelAcciones = document.getElementById('panel-acciones');

    // --- 游뚿 CAMBIO: Nuevos elementos de filtro ---
    const filtroCanal = document.getElementById('filtro-canal');
    const filtroFechaInicio = document.getElementById('filtro-fecha-inicio');
    const filtroFechaFin = document.getElementById('filtro-fecha-fin');
    const btnAplicarFiltro = document.getElementById('btn-aplicar-filtro');

    let pedidos = []; 
    let pedidoSeleccionado = null;

    // --- 1. VERIFICACI칍N Y SESI칍N ---
    const token = localStorage.getItem('authToken');
    if(token) {
        const userData = parseJwt(token);
        if (userData && userData.username) document.getElementById('user-identifier').textContent = userData.username;
    } else {
        window.location.href = 'login.html';
    }
    const cerrarSesion = () => {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userRole');
        window.location.href = 'login.html';
    };
    document.getElementById('btn-logout').addEventListener('click', cerrarSesion);

    // --- 2. FUNCI칍N PRINCIPAL DE RENDERIZADO CON FILTROS ---
    const renderPedidos = async () => {
        // --- 游뚿 CAMBIO: Leer todos los filtros ---
        const canal = filtroCanal.value;
        const fechaInicio = filtroFechaInicio.value;
        const fechaFin = filtroFechaFin.value;

        // Construir URL con par치metros de forma segura
        let params = new URLSearchParams();
        if (canal && canal !== 'Todos') params.append('canal', canal);
        if (fechaInicio) params.append('fechaInicio', fechaInicio);
        if (fechaFin) params.append('fechaFin', fechaFin);
        
        const queryString = params.toString();
        const url = queryString ? `${API_PEDIDOS_URL}?${queryString}` : API_PEDIDOS_URL;

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Error al cargar pedidos.');

            pedidos = await response.json();
            tablaBody.innerHTML = '';

            if (pedidos.length === 0) {
                 // --- 游뚿 CAMBIO: Colspan actualizado a 8 ---
                 tablaBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No se encontraron pedidos para este filtro.</td></tr>';
                 mostrarDetalles(null);
                 return;
            }

            pedidos.forEach(pedido => {
                const tr = document.createElement('tr');
                tr.dataset.pedidoId = pedido.id;

                let colorEstado = '';
                if (pedido.estado === 'Entregado') colorEstado = 'style="background-color: #d4edda; font-weight: bold;"';
                else if (pedido.estado === 'Cancelado') colorEstado = 'style="background-color: #f8d7da; text-decoration: line-through;"';

                // --- 游뚿 CAMBIO: Formatear fecha y hora ---
                const fechaObj = new Date(pedido.fecha_creacion);
                const fecha = fechaObj.toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const hora = fechaObj.toLocaleTimeString('es-MX', {hour: '2-digit', minute:'2-digit'});
                const canal = pedido.canal_venta || 'N/A'; 

                tr.innerHTML = `
                    <td>${pedido.id.toString().padStart(3, '0')}</td>
                    <td>${canal}</td>
                    <td>${pedido.cliente}</td>
                    <td ${colorEstado}>${pedido.estado}</td>
                    <td>$${pedido.total.toFixed(2)}</td>
                    <td>${fecha}</td>
                    <td>${hora}</td>
                    <td><button class="btn btn-secondary btn-detalle" data-id="${pedido.id}">Ver</button></td>
                `;
                tablaBody.appendChild(tr);
            });
            mostrarDetalles(null); 
        } catch (error) {
            console.error('Error al cargar pedidos:', error);
            tablaBody.innerHTML = '<tr><td colspan="8" style="color:red; font-weight:bold;">Error: No se pudo cargar la lista de pedidos.</td></tr>';
        }
    };

    // --- 3. FUNCI칍N DE DETALLES Y ACCIONES ---
    const mostrarDetalles = (id) => {
        detalleContenido.innerHTML = '<p>Selecciona un pedido de la lista para ver sus detalles.</p>';
        panelAcciones.innerHTML = '';

        if (!id) return;
        pedidoSeleccionado = pedidos.find(p => p.id == id);
        if (!pedidoSeleccionado) return;

        let itemsHTML = '';
        // --- 游뚿 CORRECCI칍N DE BUG: Usar nombre_producto y precio_unitario ---
        pedidoSeleccionado.items.forEach(item => {
            const subtotal = item.cantidad * item.precio_unitario;
            itemsHTML += `<li>${item.cantidad}x ${item.nombre_producto} ($${subtotal.toFixed(2)})</li>`;
        });

        detalleContenido.innerHTML = `
            <p><strong>Cliente:</strong> ${pedidoSeleccionado.cliente}</p>
            <p><strong>Canal:</strong> ${pedidoSeleccionado.canal_venta || 'N/A'}</p>
            <p><strong>Estado:</strong> ${pedidoSeleccionado.estado}</p>
            <p><strong>Total:</strong> $${pedidoSeleccionado.total.toFixed(2)}</p>
            <hr>
            <h4>Productos:</h4>
            <ul>${itemsHTML}</ul>
        `;

        if (pedidoSeleccionado.estado === 'Pendiente') {
            panelAcciones.innerHTML = `
                <button id="btn-marcar-entregado" class="btn btn-success" data-id="${id}">Marcar Entregado</button>
                <button id="btn-marcar-cancelado" class="btn btn-danger" data-id="${id}">Marcar Cancelado</button>
            `;
        } else {
             panelAcciones.innerHTML = `<p style="color:gray;">Este pedido ya fue ${pedidoSeleccionado.estado}.</p>`;
        }
    };

    // --- 4. FUNCI칍N DE CAMBIO DE ESTADO ---
    const cambiarEstado = async (id, nuevoEstado) => {
        try {
            const response = await fetch(`${API_PEDIDOS_URL}/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ estado: nuevoEstado }) 
            });
            if (!response.ok) throw new Error('Error al actualizar estado.');
            alert(`Pedido #${id} actualizado a ${nuevoEstado} con 칠xito.`);
            renderPedidos(); 
        } catch (error) {
            console.error('Error al cambiar estado:', error);
            alert('Fallo al cambiar el estado: ' + error.message);
        }
    };

    // --- 5. EVENT LISTENERS ---
    btnAplicarFiltro.addEventListener('click', renderPedidos);

    tablaBody.addEventListener('click', (e) => {
        // --- 游뚿 CORRECCI칍N DE BUG: Escuchar clic en el bot칩n, no en la fila ---
        const detalleBtn = e.target.closest('.btn-detalle');
        if (detalleBtn) {
            mostrarDetalles(detalleBtn.dataset.id);
        }
    });

    panelAcciones.addEventListener('click', (e) => {
        const id = pedidoSeleccionado?.id;
        if (!id) return;
        if (e.target.id === 'btn-marcar-entregado') {
            if (confirm(`쮺onfirmas marcar el Pedido #${id} como ENTREGADO? Esto descontar치 el inventario.`)) {
                cambiarEstado(id, 'Entregado');
            }
        } else if (e.target.id === 'btn-marcar-cancelado') {
            if (confirm(`쮺onfirmas marcar el Pedido #${id} como CANCELADO?`)) {
                 cambiarEstado(id, 'Cancelado');
            }
        }
    });

    // --- 6. INICIALIZACI칍N ---
    renderPedidos(); // Carga inicial al abrir la p치gina
});
</script>
</body>
</html>
