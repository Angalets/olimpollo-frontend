<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>POS Profesional - Olimpollo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
    <style>
        /* ==========================================================================
           TEMA POS PROFESIONAL (ALTO RENDIMIENTO Y T√ÅCTIL)
           ========================================================================== */
        :root {
            --bg-dark: #0F172A; --bg-panel: #1E293B; --bg-light: #F1F5F9; --white: #FFFFFF;
            --text-main: #334155; --text-muted: #64748B; --text-light: #F8FAFC;
            --primary: #3B82F6; --primary-hover: #2563EB;
            --success: #10B981; --success-hover: #059669;
            --danger: #EF4444; --warning: #F59E0B;
            --border: #E2E8F0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; user-select: none; }
        
        body { background-color: var(--bg-light); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER POS */
        header { background: var(--bg-dark); color: var(--white); padding: 0 20px; height: 60px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 50; flex-shrink: 0; }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .logo { font-size: 20px; font-weight: 800; letter-spacing: 1px; color: var(--white); text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .nav-links a { color: #94A3B8; text-decoration: none; font-weight: 600; font-size: 14px; transition: 0.2s; padding: 8px 12px; border-radius: 6px; }
        .nav-links a:hover, .nav-links a.active { color: var(--white); background: rgba(255,255,255,0.1); }
        .header-actions { display: flex; align-items: center; gap: 15px; }
        .btn-intercom { background: var(--warning); color: #fff; border: none; padding: 8px 15px; border-radius: 6px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 14px; transition: 0.2s; }
        .btn-intercom:hover { transform: scale(1.05); }
        .user-badge { font-size: 13px; font-weight: 600; background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 20px; }
        .btn-logout { background: transparent; color: var(--text-muted); border: 1px solid var(--text-muted); padding: 5px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; }

        /* MAIN LAYOUT (2 COLUMNAS) */
        main { display: flex; flex: 1; height: calc(100vh - 60px); overflow: hidden; }

        /* PANEL IZQUIERDO: MEN√ö */
        .menu-panel { flex: 1; display: flex; flex-direction: column; background: var(--bg-light); border-right: 1px solid var(--border); }
        
        /* Barra de Categor√≠as */
        .category-bar { display: flex; gap: 10px; padding: 15px; background: var(--white); overflow-x: auto; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .category-bar::-webkit-scrollbar { display: none; }
        .btn-category { padding: 12px 20px; border: 2px solid transparent; background: var(--bg-light); color: var(--text-muted); border-radius: 30px; font-weight: 700; font-size: 14px; cursor: pointer; white-space: nowrap; transition: 0.2s; }
        .btn-category.active { background: var(--primary); color: var(--white); border-color: var(--primary-hover); box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); }

        /* Grid de Productos */
        .products-grid { flex: 1; overflow-y: auto; padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; align-content: start; }
        .products-grid::-webkit-scrollbar { width: 8px; }
        .products-grid::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 4px; }
        
        .btn-product { background: var(--white); border: 2px solid transparent; border-radius: 12px; padding: 15px 10px; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; align-items: center; text-align: center; height: 140px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.1s; position: relative; overflow: hidden; }
        .btn-product:active { transform: scale(0.95); }
        .btn-product.has-mods { border-color: var(--primary); }
        .btn-product.has-mods::after { content: 'MODS'; position: absolute; top: 0; right: 0; background: var(--primary); color: white; font-size: 9px; font-weight: 800; padding: 2px 6px; border-bottom-left-radius: 8px; }
        .prod-name { font-size: 15px; font-weight: 700; color: var(--text-main); line-height: 1.2; }
        .prod-price { font-size: 16px; font-weight: 800; color: var(--success); }

        /* PANEL DERECHO: TICKET (CARRITO Y COBRO) */
        .ticket-panel { width: 420px; background: var(--white); display: flex; flex-direction: column; flex-shrink: 0; box-shadow: -4px 0 15px rgba(0,0,0,0.05); z-index: 10; }
        
        /* 1. Cliente CRM (Fijo arriba) */
        .ticket-customer { padding: 15px; border-bottom: 1px solid var(--border); background: #F8FAFC; }
        .search-crm { display: flex; gap: 8px; margin-bottom: 10px; }
        .input-crm { flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; outline: none; }
        .input-crm:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        .btn-search { background: var(--bg-panel); color: white; border: none; padding: 0 15px; border-radius: 8px; cursor: pointer; }
        #info-cliente-crm { font-size: 12px; font-weight: 600; padding: 5px 10px; border-radius: 6px; display: none; }

        /* 2. Lista de Items (Scrollable) */
        .ticket-items { flex: 1; overflow-y: auto; padding: 15px; background: var(--white); }
        .ticket-items::-webkit-scrollbar { width: 4px; }
        .ticket-items::-webkit-scrollbar-thumb { background: #E2E8F0; }
        .empty-cart { text-align: center; color: var(--text-muted); margin-top: 50px; font-weight: 500; font-size: 18px; }
        .empty-cart i { font-size: 40px; color: #CBD5E1; margin-bottom: 15px; display: block; }

        .cart-item { display: flex; flex-direction: column; padding: 12px 0; border-bottom: 1px dashed var(--border); }
        .cart-item-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .item-info { flex: 1; padding-right: 10px; }
        .item-name { font-weight: 700; font-size: 15px; }
        .item-mods { font-size: 12px; color: var(--text-muted); display: block; line-height: 1.2; margin-top: 2px; }
        .item-note { font-size: 11px; color: var(--warning); font-weight: 600; display: block; margin-top: 2px; }
        .item-price { font-weight: 800; font-size: 15px; width: 70px; text-align: right; }
        
        .item-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
        .qty-controls { display: flex; align-items: center; background: var(--bg-light); border-radius: 20px; overflow: hidden; }
        .btn-qty { background: transparent; border: none; width: 35px; height: 32px; font-size: 18px; font-weight: bold; cursor: pointer; color: var(--text-main); }
        .btn-qty:hover { background: #E2E8F0; }
        .qty-display { width: 30px; text-align: center; font-weight: 700; font-size: 14px; }
        .btn-action-sm { background: var(--bg-light); border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; color: var(--text-muted); transition: 0.2s; }
        .btn-action-sm:hover { background: #E2E8F0; color: var(--text-main); }

        /* 3. Panel de Cobro (Fijo abajo) */
        .ticket-checkout { padding: 15px; border-top: 2px solid var(--border); background: var(--bg-light); flex-shrink: 0; }
        
        .checkout-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .checkout-group label { display: block; font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; }
        .select-btn { width: 100%; padding: 10px; background: var(--white); border: 1px solid var(--border); border-radius: 8px; font-weight: 600; font-size: 13px; color: var(--text-main); cursor: pointer; text-align: left; display: flex; justify-content: space-between; }
        .select-btn:after { content: '\f0d7'; font-family: 'Font Awesome 6 Free'; font-weight: 900; }
        
        .totals-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; }
        .total-label { font-size: 14px; font-weight: 700; color: var(--text-muted); }
        .total-amount { font-size: 32px; font-weight: 800; color: var(--text-main); line-height: 1; }
        #info-comision { font-size: 12px; font-weight: 600; color: var(--danger); text-align: right; margin-bottom: 15px; display: none; }

        .btn-pay { width: 100%; background: var(--success); color: white; border: none; padding: 18px; border-radius: 12px; font-size: 20px; font-weight: 800; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
        .btn-pay:hover { background: var(--success-hover); transform: translateY(-2px); }

        /* MODALES (General) */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); justify-content: center; align-items: center; }
        .modal-content { background: var(--white); padding: 30px; border-radius: 16px; width: 90%; max-width: 450px; position: relative; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .close { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; color: var(--text-muted); }
        
        /* Modal Opciones Espec√≠ficas */
        .opt-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .btn-opt { background: var(--bg-light); border: 2px solid transparent; padding: 15px; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: 0.2s; }
        .btn-opt.active { background: #EFF6FF; border-color: var(--primary); color: var(--primary-hover); }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <a href="index.html" class="logo"><i class="fas fa-cash-register"></i> POS Olimpollo</a>
            <nav class="nav-links">
                <a href="pedidos_lista.html">Historial</a>
                <a href="clientes.html">CRM</a>
                <a href="inventario.html">Stock</a>
            </nav>
        </div>
        <div class="header-actions">
            <button id="btn-abrir-intercom" class="btn-intercom"><i class="fas fa-bullhorn"></i> Cocina</button>
            <span class="user-badge" id="user-identifier">Cajero</span>
            <button class="btn-logout" id="btn-logout"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </header>

    <main>
        <div class="menu-panel">
            <div class="category-bar" id="category-container">
                <button class="btn-category active" data-cat="Todos">Todos</button>
                </div>
            <div class="products-grid" id="productos-container">
                <p style="grid-column: 1/-1; text-align:center; padding: 40px;">Cargando men√∫...</p>
            </div>
        </div>

        <div class="ticket-panel">
            
            <div class="ticket-customer">
                <div class="search-crm">
                    <input type="tel" id="cliente-telefono" class="input-crm" placeholder="Tel√©fono del cliente...">
                    <button type="button" id="btn-buscar-cliente" class="btn-search"><i class="fas fa-search"></i></button>
                </div>
                <input type="text" id="cliente-nombre" class="input-crm" placeholder="Nombre completo" style="width: 100%; display: none;">
                <div id="info-cliente-crm"></div>
            </div>

            <div class="ticket-items" id="lista-carrito">
                <div class="empty-cart">
                    <i class="fas fa-shopping-basket"></i>
                    Ticket vac√≠o
                </div>
            </div>

            <div class="ticket-checkout">
                <div class="checkout-grid">
                    <div class="checkout-group">
                        <label>Canal de Venta</label>
                        <button class="select-btn" id="btn-select-canal">OyR</button>
                    </div>
                    <div class="checkout-group">
                        <label>M√©todo de Pago</label>
                        <button class="select-btn" id="btn-select-pago">Efectivo</button>
                    </div>
                </div>

                <div class="checkout-group" style="margin-bottom: 15px;">
                    <label>Ajuste Manual de Total ($)</label>
                    <input type="number" id="ajuste-total" class="input-crm" placeholder="Opcional. Ej: 200" step="0.01">
                </div>

                <div class="totals-row">
                    <span class="total-label">TOTAL A COBRAR</span>
                    <span class="total-amount" id="total-pedido">$0.00</span>
                </div>
                <div id="info-comision"></div>

                <button class="btn-pay" id="btn-cobrar">
                    <i class="fas fa-check-circle"></i> COBRAR PEDIDO
                </button>
            </div>
        </div>
    </main>

    <div id="modalSelector" class="modal">
        <div class="modal-content">
            <span class="close" id="close-selector">&times;</span>
            <h3 id="selector-title" style="margin-bottom: 15px; color: var(--text-main);">Seleccionar</h3>
            <div class="opt-grid" id="selector-options"></div>
        </div>
    </div>

    <div id="modalModificadores" class="modal">
        <div class="modal-content">
            <h3 id="modal-mod-titulo" style="margin-bottom: 15px; color: var(--text-main);">Personalizar</h3>
            <div class="opt-grid" id="modal-mod-opciones" style="display: flex; flex-direction: column; gap: 8px;"></div>
            <button id="btn-cancelar-mod" style="margin-top: 20px; width: 100%; padding: 12px; background: var(--bg-light); border:none; border-radius:8px; font-weight:bold; cursor:pointer;">Cancelar</button>
        </div>
    </div>

    <div id="modalIntercom" class="modal">
        <div class="modal-content">
            <span class="close" id="close-intercom">&times;</span>
            <h3 style="color: var(--warning); margin-bottom: 5px;"><i class="fas fa-bullhorn"></i> Alerta a Cocina</h3>
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 20px;">Sonar√° un zumbido en la pantalla de cocina.</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <button class="btn-opt btn-quick-alert" style="padding: 10px;">üóëÔ∏è Basura</button>
                <button class="btn-opt btn-quick-alert" style="padding: 10px;">üßª Servilletas</button>
                <button class="btn-opt btn-quick-alert" style="padding: 10px;">üßπ Limpiar</button>
                <button class="btn-opt btn-quick-alert" style="padding: 10px;">üö∂‚Äç‚ôÇÔ∏è Venir a Caja</button>
            </div>
            <input type="text" id="input-alerta" class="input-crm" placeholder="Mensaje personalizado..." style="margin-bottom: 15px;">
            <button id="btn-enviar-alerta" class="btn-pay" style="padding: 12px; font-size:16px;">Enviar Alerta</button>
        </div>
    </div>

    <script>
        function parseJwt(token) { try { const base64Url = token.split('.')[1]; const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/'); const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); return JSON.parse(jsonPayload); } catch (e) { return null; } }

        document.addEventListener('DOMContentLoaded', () => {
            const API_MENU_URL = 'https://olimpollo-api.onrender.com/api/menu/pos';
            const API_PEDIDOS_URL = 'https://olimpollo-api.onrender.com/api/pedidos';
            const API_ALERTAS_URL = 'https://olimpollo-api.onrender.com/api/alertas'; 
            
            let menuData = { productos: [], opciones: {} };
            let carrito = [];
            let selectedCanal = 'OyR';
            let selectedPago = 'Efectivo'; 

            // DOM
            const menuContainer = document.getElementById('productos-container');
            const categoryContainer = document.getElementById('category-container');
            const listaCarrito = document.getElementById('lista-carrito');
            const totalPedidoSpan = document.getElementById('total-pedido');
            const infoComision = document.getElementById('info-comision'); 
            const inputAjusteTotal = document.getElementById('ajuste-total');
            const btnCobrar = document.getElementById('btn-cobrar');
            
            const inputTelefono = document.getElementById('cliente-telefono');
            const inputClienteNombre = document.getElementById('cliente-nombre');
            const btnBuscarCliente = document.getElementById('btn-buscar-cliente');
            const infoClienteCRM = document.getElementById('info-cliente-crm');

            // --- AUTH ---
            const token = localStorage.getItem('authToken'); 
            if(token) { 
                const u = parseJwt(token); 
                if(u) document.getElementById('user-identifier').textContent = u.username; 
            } else { window.location.href = 'login.html'; }
            document.getElementById('btn-logout').addEventListener('click', () => {localStorage.clear(); window.location.href='login.html'});

            // --- SELECTORES MODALES (Canal / Pago) ---
            const modalSelector = document.getElementById('modalSelector');
            const selectorOptions = document.getElementById('selector-options');
            const btnSelectCanal = document.getElementById('btn-select-canal');
            const btnSelectPago = document.getElementById('btn-select-pago');
            
            document.getElementById('close-selector').onclick = () => modalSelector.style.display = 'none';
            
            const openSelector = (title, options, currentVal, callback) => {
                document.getElementById('selector-title').textContent = title;
                selectorOptions.innerHTML = '';
                options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = `btn-opt ${opt === currentVal ? 'active' : ''}`;
                    btn.textContent = opt;
                    btn.onclick = () => { callback(opt); modalSelector.style.display = 'none'; };
                    selectorOptions.appendChild(btn);
                });
                modalSelector.style.display = 'flex';
            };

            btnSelectCanal.onclick = () => openSelector('Canal de Venta', ['OyR', 'Uber', 'Didi', 'Rappi', 'Empleado'], selectedCanal, (val) => {
                selectedCanal = val; btnSelectCanal.textContent = val;
                if (['Uber', 'Didi', 'Rappi'].includes(val)) { selectedPago = 'Aplicaci√≥n'; btnSelectPago.textContent = 'Aplicaci√≥n'; }
                else if (val === 'OyR' && selectedPago === 'Aplicaci√≥n') { selectedPago = 'Efectivo'; btnSelectPago.textContent = 'Efectivo'; }
                calcularTotal();
            });

            btnSelectPago.onclick = () => openSelector('M√©todo de Pago', ['Efectivo', 'Tarjeta', 'Transferencia', 'Aplicaci√≥n'], selectedPago, (val) => {
                selectedPago = val; btnSelectPago.textContent = val; calcularTotal();
            });

            // --- INTERCOMUNICADOR ---
            const modalIntercom = document.getElementById('modalIntercom');
            document.getElementById('btn-abrir-intercom').onclick = () => { document.getElementById('input-alerta').value = ''; modalIntercom.style.display = 'flex'; };
            document.getElementById('close-intercom').onclick = () => modalIntercom.style.display = 'none';
            document.querySelectorAll('.btn-quick-alert').forEach(b => b.onclick = (e) => document.getElementById('input-alerta').value = e.target.textContent.replace(/[^\w\s√±√°√©√≠√≥√∫]/gi, '').trim());
            
            document.getElementById('btn-enviar-alerta').onclick = async () => {
                const mensaje = document.getElementById('input-alerta').value.trim();
                if (!mensaje) return;
                try {
                    await fetch(API_ALERTAS_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ mensaje }) });
                    modalIntercom.style.display = 'none';
                } catch (e) { alert("Error"); }
            };

            // --- CRM ---
            btnBuscarCliente.addEventListener('click', async () => {
                const tel = inputTelefono.value.trim();
                if (tel.length < 7) return alert("N√∫mero inv√°lido");
                inputClienteNombre.style.display = 'block';
                try {
                    const res = await fetch(`https://olimpollo-api.onrender.com/api/clientes/exacto/${tel}`);
                    if (res.ok) {
                        const c = await res.json();
                        inputClienteNombre.value = c.nombre;
                        infoClienteCRM.style.display = 'block'; infoClienteCRM.style.background = '#DCFCE7'; infoClienteCRM.style.color = '#059669';
                        infoClienteCRM.innerHTML = `üåü Frecuente | Visitas: ${c.visitas} | Puntos: ${c.puntos}`;
                    } else {
                        infoClienteCRM.style.display = 'block'; infoClienteCRM.style.background = '#F1F5F9'; infoClienteCRM.style.color = '#64748B';
                        infoClienteCRM.innerHTML = `üÜï Nuevo Cliente`; inputClienteNombre.focus();
                    }
                } catch (e) { }
            });

            // --- RENDER MEN√ö ---
            const renderCategorias = () => {
                const cats = ['Todos', ...new Set(menuData.productos.map(p => p.categoria))];
                categoryContainer.innerHTML = '';
                cats.forEach(c => {
                    const btn = document.createElement('button');
                    btn.className = `btn-category ${c === 'Todos' ? 'active' : ''}`;
                    btn.textContent = c;
                    btn.onclick = () => {
                        document.querySelectorAll('.btn-category').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        renderProductos(c);
                    };
                    categoryContainer.appendChild(btn);
                });
            };

            const renderProductos = (filtroCat = 'Todos') => {
                const colores = {'Platos Fuertes':'#FEF2F2','Sides':'#FFFBEB','Bebidas':'#F8FAFC','PROMOS':'#ECFDF5','Aderezos':'#F1F5F9'};
                menuContainer.innerHTML = '';
                const filtrados = filtroCat === 'Todos' ? menuData.productos : menuData.productos.filter(p => p.categoria === filtroCat);
                
                filtrados.forEach(p => {
                    const btn = document.createElement('div');
                    btn.className = `btn-product ${p.grupos_modificadores ? 'has-mods' : ''}`;
                    btn.style.backgroundColor = colores[p.categoria] || '#ffffff';
                    btn.innerHTML = `<span class="prod-name">${p.nombre_venta}</span><span class="prod-price">$${p.precio_base.toFixed(2)}</span>`;
                    
                    btn.onclick = async () => {
                        let modsAcum = []; let precioAdicional = 0;
                        if (p.grupos_modificadores) {
                            const grupos = p.grupos_modificadores.split(',').map(g => g.trim()).filter(Boolean);
                            try {
                                for (const g of grupos) {
                                    const opcs = menuData.opciones[g] || [];
                                    if(opcs.length > 0) {
                                        const sel = await solicitarOpcion(`Selecciona ${g}`, opcs);
                                        modsAcum.push(sel); precioAdicional += sel.precio_adicional;
                                    }
                                }
                            } catch (e) { return; } // Cancelado
                        }
                        agregarAlCarrito(p, modsAcum, precioAdicional);
                    };
                    menuContainer.appendChild(btn);
                });
            };

            // --- CARRITO INTELIGENTE ---
            const agregarAlCarrito = (producto, mods, extraPrice) => {
                const modStr = mods.map(m => m.valor).join(', ');
                const precioUnidad = producto.precio_base + extraPrice;
                
                // Buscar si existe exactamente el mismo (agrupar)
                const index = carrito.findIndex(i => i.id === producto.id && i.mods === modStr && i.notas === '');
                if (index > -1) {
                    carrito[index].cantidad++;
                } else {
                    carrito.push({ id: producto.id, nombre: producto.nombre_venta, precio: precioUnidad, cantidad: 1, mods: modStr, notas: '' });
                }
                renderCarrito();
            };

            const renderCarrito = () => {
                listaCarrito.innerHTML = '';
                if (carrito.length === 0) { listaCarrito.innerHTML = `<div class="empty-cart"><i class="fas fa-shopping-basket"></i>Ticket vac√≠o</div>`; calcularTotal(); return; }
                
                carrito.forEach((item, index) => {
                    const div = document.createElement('div'); div.className = 'cart-item';
                    div.innerHTML = `
                        <div class="cart-item-header">
                            <div class="item-info">
                                <span class="item-name">${item.nombre}</span>
                                ${item.mods ? `<span class="item-mods">${item.mods}</span>` : ''}
                                ${item.notas ? `<span class="item-note">üìù ${item.notas}</span>` : ''}
                            </div>
                            <div class="item-price">$${(item.precio * item.cantidad).toFixed(2)}</div>
                        </div>
                        <div class="item-controls">
                            <button class="btn-action-sm" onclick="addNota(${index})"><i class="fas fa-pen"></i> Nota</button>
                            <div class="qty-controls">
                                <button class="btn-qty" onclick="modQty(${index}, -1)">-</button>
                                <div class="qty-display">${item.cantidad}</div>
                                <button class="btn-qty" onclick="modQty(${index}, 1)">+</button>
                            </div>
                        </div>
                    `;
                    listaCarrito.appendChild(div);
                });
                calcularTotal();
            };

            window.modQty = (idx, delta) => {
                carrito[idx].cantidad += delta;
                if (carrito[idx].cantidad <= 0) carrito.splice(idx, 1);
                renderCarrito();
            };
            window.addNota = (idx) => {
                const n = prompt("Nota de cocina:", carrito[idx].notas);
                if (n !== null) { carrito[idx].notas = n.trim(); renderCarrito(); }
            };

            // --- C√ÅLCULOS Y COBRO ---
            const calcularTotal = () => {
                const totalCar = carrito.reduce((s, i) => s + (i.precio * i.cantidad), 0);
                const manual = parseFloat(inputAjusteTotal.value);
                const total = (manual && manual > 0) ? manual : totalCar;

                totalPedidoSpan.textContent = `$${total.toFixed(2)}`;
                if (manual) totalPedidoSpan.textContent += ' *';

                if (total > 0 && selectedPago === 'Tarjeta') {
                    const c = total * 0.04176; 
                    infoComision.style.display = 'block';
                    infoComision.innerHTML = `Comisi√≥n Tarjeta: -$${c.toFixed(2)} | Recibes: $${(total-c).toFixed(2)}`;
                } else if (total > 0 && selectedPago === 'Aplicaci√≥n') {
                    if(!manual) { infoComision.style.display='block'; infoComision.innerHTML = `<span style="color:#F59E0B;">‚ö†Ô∏è Ingresa el total ajustado de la App arriba</span>`; }
                    else { const c = total * 0.4213; infoComision.style.display='block'; infoComision.innerHTML = `Comisi√≥n App: -$${c.toFixed(2)} | Recibes: $${(total-c).toFixed(2)}`; }
                } else { infoComision.style.display = 'none'; }
                
                return total;
            };
            inputAjusteTotal.addEventListener('input', calcularTotal);

            // FINALIZAR
            btnCobrar.addEventListener('click', async () => {
                if (carrito.length === 0) return alert('El ticket est√° vac√≠o.');
                const manual = parseFloat(inputAjusteTotal.value);
                if (selectedCanal !== 'OyR' && !manual) return alert('Para pedidos de App, ingresa el Total Ajustado exacto.');
                
                btnCobrar.disabled = true; btnCobrar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
                const totalFinal = calcularTotal();
                
                const payload = { 
                    cliente: inputClienteNombre.value.trim() || 'Mostrador', telefono: inputTelefono.value.trim(), 
                    canal_venta: selectedCanal, metodo_pago: selectedPago, total_ajustado: totalFinal, 
                    items: carrito.map(i => ({ menu_producto_id: i.id, nombre_producto_completo: i.nombre + (i.mods ? ` (${i.mods})` : ''), cantidad: i.cantidad, precio_unitario: i.precio, notas: i.notas })) 
                };

                try {
                    const res = await fetch(API_PEDIDOS_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!res.ok) throw new Error('Error al guardar');
                    alert('‚úÖ Pedido cobrado con √©xito.');
                    
                    // Reset
                    carrito = []; inputAjusteTotal.value = ''; inputTelefono.value = ''; inputClienteNombre.value = ''; inputClienteNombre.style.display = 'none'; infoClienteCRM.style.display = 'none';
                    selectedCanal = 'OyR'; selectedPago = 'Efectivo'; btnSelectCanal.textContent = 'OyR'; btnSelectPago.textContent = 'Efectivo';
                    renderCarrito();
                } catch (e) { alert('Error: ' + e.message); } finally { btnCobrar.disabled = false; btnCobrar.innerHTML = '<i class="fas fa-check-circle"></i> COBRAR PEDIDO'; }
            });

            // MODAL HELPERS
            const solicitarOpcion = (titulo, opciones) => {
                return new Promise((resolve, reject) => {
                    document.getElementById('modal-mod-titulo').textContent = titulo;
                    const container = document.getElementById('modal-mod-opciones'); container.innerHTML = '';
                    const modal = document.getElementById('modalModificadores');
                    
                    const cleanup = () => { modal.style.display = 'none'; };
                    opciones.forEach(op => {
                        const b = document.createElement('button'); b.className = 'btn-opt';
                        b.style.display = 'flex'; b.style.justifyContent = 'space-between';
                        b.innerHTML = `<span>${op.valor}</span> ${op.precio_adicional > 0 ? `<span style="color:var(--success)">+$${op.precio_adicional.toFixed(2)}</span>` : ''}`;
                        b.onclick = () => { cleanup(); resolve(op); }; container.appendChild(b);
                    });
                    document.getElementById('btn-cancelar-mod').onclick = () => { cleanup(); reject(new Error('Cancelado')); };
                    modal.style.display = 'flex';
                });
            };

            // INICIALIZAR
            const init = async () => {
                try {
                    const r = await fetch(API_MENU_URL); menuData = await r.json();
                    renderCategorias(); renderProductos();
                } catch (e) { menuContainer.innerHTML = 'Error de red'; }
            };
            init();
            window.addEventListener('click', (e) => { document.querySelectorAll('.modal').forEach(m => { if(e.target === m) m.style.display='none'; }) });
        });
    </script>
</body>
</html>
