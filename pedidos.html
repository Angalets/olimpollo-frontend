<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Olimpollo - Punto de Venta</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  
    <style>
        /* ESTILOS BASE */
        :root{--bg-main:#ECF0F1;--bg-header:#FFFFFF;--card-bg:#FFFFFF;--primary-text:#502c2c;--secondary-text:#808B96;--accent-color:#db3434;--accent-hover:#b92929;--border-color:#D5D8DC;--shadow-light:0 4px 15px rgba(0, 0, 0, 0.08);--shadow-heavy:0 10px 20px rgba(0, 0, 0, 0.12);--payment-color:#2980B9;}
        body{margin:0;font-family:'Poppins', sans-serif;background-color:var(--bg-main);color:var(--primary-text);display:flex;flex-direction:column;min-height:100vh;}header{background:var(--bg-header);padding:15px 40px;box-shadow:0 2px 10px rgba(0, 0, 0, 0.05);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);}header .logo{font-size:24px;font-weight:600;text-decoration:none;color:var(--primary-text);}header nav{display:flex;gap:20px;}header nav a{text-decoration:none;color:var(--secondary-text);font-weight:500;transition:color 0.3s;}header nav a:hover{color:var(--accent-color);}.user-info{display:flex;align-items:center;gap:20px;}#user-identifier{font-weight:500;background-color:var(--bg-main);padding:5px 12px;border-radius:15px;font-size:14px;}.logout{background:var(--accent-color);color:white;border:none;padding:8px 18px;border-radius:20px;cursor:pointer;font-size:14px;font-weight:500;transition:background-color 0.3s;}.logout:hover{background-color:var(--accent-hover);}main{flex:1;padding:40px;max-width:1400px;margin:0 auto;width:100%;box-sizing:border-box;}h2.page-title{margin-bottom:30px;font-size:28px;font-weight:600;}.card{background:var(--card-bg);border-radius:12px;padding:25px;box-shadow:var(--shadow-light);margin-bottom:25px;}table{width:100%;border-collapse:collapse;background:var(--card-bg);border-radius:12px;overflow:hidden;box-shadow:var(--shadow-light);}th, td{padding:15px;text-align:left;border-bottom:1px solid var(--bg-main);}
        
        /* ESTILOS POS */
        .pos-container { display: flex; gap: 25px; align-items: flex-start; }
        .menu-area { flex: 2; }
        .carrito-card { flex: 1; position: sticky; top: 40px; }
        .productos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
        .btn-producto { width: 100%; aspect-ratio: 1 / 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; border: 1px solid var(--border-color); padding: 10px; color: var(--primary-text); border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: background 0.2s, transform 0.2s; word-wrap: break-word; }
        .btn-producto:hover { transform: translateY(-4px); }
        .carrito-list { list-style: none; padding: 0; margin: 0 0 20px 0; max-height: 300px; overflow-y: auto; }
        .carrito-list li { display: flex; justify-content: space-between; align-items: flex-start; padding: 10px 0; border-bottom: 1px solid var(--bg-main); }
        
        /* Botones de acci√≥n del carrito */
        .btn-item-action { border: none; padding: 5px 8px; font-size: 14px; cursor: pointer; border-radius: 4px; margin-left: 3px;}
        .btn-nota { background: #f39c12; color: white; } 
        .btn-duplicar { background: #007bff; color: white; }
        .btn-eliminar { background: #e74c3c; color: white; }
        .btn-modificador { width: 100%; padding: 15px; font-size: 16px; font-weight: bold; cursor: pointer; border: 1px solid #ddd; background: #f9f9f9; border-radius: 5px; transition: background 0.2s; }
        .btn-modificador:hover { background: #FCF3CF; }
        
        /* Estilos Botones Selecci√≥n */
        .canal-botones-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .btn-selector { padding: 12px 5px; border: 2px solid var(--border-color); background-color: transparent; color: var(--secondary-text); border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s ease-in-out; }
        
        .btn-selector.btn-canal.active { background-color: var(--accent-color); color: white; border-color: var(--accent-color); transform: scale(1.05); }
        .btn-selector.btn-pago.active { background-color: var(--payment-color); color: white; border-color: var(--payment-color); transform: scale(1.05); }

        .item-nota { display: block; font-size: 12px; color: #e67e22; font-style: italic; margin-top: 2px; font-weight: 600; border-left: 2px solid #e67e22; padding-left: 5px; }
        
        .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);justify-content:center;align-items:center;}.modal-content{background:var(--card-bg);padding:30px;border-radius:12px;box-shadow:var(--shadow-heavy);width:90%;max-width:500px;position:relative;}.close{position:absolute;top:15px;right:20px;font-size:28px;cursor:pointer;color:var(--secondary-text);}
        footer{text-align:center;padding:20px;font-size:14px;color:var(--secondary-text);}
        .btn-primary { background: var(--accent-color); color: white; border: none; border-radius: 8px; cursor: pointer;}
        .btn-secondary { background: var(--secondary-text); color: white; border: none; border-radius: 8px; cursor: pointer;}
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">Olimpollo</a>
        <nav>
          <a href="pedidos.html" style="color: var(--accent-color);">POS</a>
          <a href="clientes.html">Clientes</a>
          <a href="reportes.html">Reportes</a>
          <a href="pedidos_lista.html">Pedidos</a>
          <a href="inventario.html">Inventario</a>
        </nav>
        <div class="user-info">
            <span id="user-identifier"></span>
            <button class="logout" id="btn-logout">Salir</button>
        </div>
    </header>

    <main>
        <h2 class="page-title">Punto de Venta (POS)</h2>
        <div class="pos-container">
            <div class="menu-area">
                <div id="productos-container" class="productos-grid card">
                    <p>Cargando men√∫...</p>
                </div>
            </div>

            <div class="carrito-card card">
                <h3>Carrito de Pedido</h3>
                <ul id="lista-carrito" class="carrito-list">
                    <li style="color: var(--secondary-text);">A√∫n no hay productos.</li>
                </ul>
                <div style="font-size: 20px; font-weight: bold; border-top: 2px solid var(--accent-color); padding-top: 15px; margin-bottom: 20px;">
                    Total: <span id="total-pedido">$0.00</span>
                    <div id="info-comision" style="font-size: 14px; color: #7f8c8d; font-weight: normal; margin-top: 8px; display: none;">
                    </div>
                </div>
                
                <form id="form-finalizar-pedido">
                    <div style="margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                        <label style="color: var(--accent-color); font-weight: bold;">Cliente (Tel√©fono):</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="cliente-telefono" placeholder="Ej: 6621234567" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
                            <button type="button" id="btn-buscar-cliente" class="btn btn-secondary" style="padding: 10px;">üîç</button>
                        </div>
                        <div id="info-cliente-crm" style="margin-top: 8px; font-size: 13px; color: #27ae60; font-weight: 600; display: none;"></div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label>Canal de Venta:</label>
                        <div id="canal-venta-botones" class="canal-botones-container" style="grid-template-columns: repeat(3, 1fr);">
                            <button type="button" class="btn-selector btn-canal active" data-canal="OyR">OyR</button>
                            <button type="button" class="btn-selector btn-canal" data-canal="Uber">Uber</button>
                            <button type="button" class="btn-selector btn-canal" data-canal="Didi">Didi</button>
                            <button type="button" class="btn-selector btn-canal" data-canal="Rappi">Rappi</button>
                            <button type="button" class="btn-selector btn-canal" data-canal="Empleado">Empleado</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label>M√©todo de Pago:</label>
                        <div id="metodo-pago-botones" class="canal-botones-container">
                            <button type="button" class="btn-selector btn-pago active" data-pago="Efectivo">Efectivo</button>
                            <button type="button" class="btn-selector btn-pago" data-pago="Tarjeta">Tarjeta</button>
                            <button type="button" class="btn-selector btn-pago" data-pago="Transferencia">Transferencia</button>
                            <button type="button" class="btn-selector btn-pago" data-pago="Aplicaci√≥n">Aplicaci√≥n</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label for="cliente-nombre">Nombre del Cliente:</label>
                        <input type="text" id="cliente-nombre" placeholder="Nombre del cliente" required>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label for="ajuste-total" style="color: var(--accent-color);">Total Recibido/Ajustado ($):</label>
                        <input type="number" id="ajuste-total" placeholder="Opcional para OyR" min="0" step="0.01">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 16px;">
                        FINALIZAR PEDIDO
                    </button>
                </form>
            </div>
        </div>
    </main>

    <div id="modalModificadores" class="modal">
        <div class="modal-content">
            <h3 id="modal-mod-titulo">Seleccionar Opci√≥n</h3>
            <div id="modal-mod-opciones" style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;"></div>
            <button id="btn-cancelar-mod" class="btn btn-secondary" style="margin-top: 20px;">Cancelar</button>
        </div>
    </div>

    <footer>&copy; 2025 Los Boneless del Olimpo</footer>

    <script>
        function parseJwt(token) { try { const base64Url = token.split('.')[1]; const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/'); const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); return JSON.parse(jsonPayload); } catch (e) { return null; } }

        document.addEventListener('DOMContentLoaded', () => {
            const API_MENU_URL = 'https://olimpollo-api.onrender.com/api/menu/pos';
            const API_PEDIDOS_URL = 'https://olimpollo-api.onrender.com/api/pedidos';
            
            let menuData = { productos: [], opciones: {} };
            let carrito = [];
            let selectedCanal = 'OyR';
            let selectedPago = 'Efectivo'; 

            // Elementos DOM
            const menuContainer = document.getElementById('productos-container');
            const listaCarrito = document.getElementById('lista-carrito');
            const totalPedidoSpan = document.getElementById('total-pedido');
            const infoComision = document.getElementById('info-comision'); 
            const formFinalizarPedido = document.getElementById('form-finalizar-pedido');
            const inputClienteNombre = document.getElementById('cliente-nombre');
            
            const canalBotonesContainer = document.getElementById('canal-venta-botones');
            const pagoBotonesContainer = document.getElementById('metodo-pago-botones');
            const inputAjusteTotal = document.getElementById('ajuste-total');
            
            const inputTelefono = document.getElementById('cliente-telefono');
            const btnBuscarCliente = document.getElementById('btn-buscar-cliente');
            const infoClienteCRM = document.getElementById('info-cliente-crm');

            // --- CRM ---
            btnBuscarCliente.addEventListener('click', async () => {
                const tel = inputTelefono.value.trim();
                if (tel.length < 7) return alert("Ingresa un n√∫mero v√°lido");
                try {
                    // AQU√ç EST√Å EL CAMBIO IMPORTANTE: Agregamos /exacto/ a la ruta
                    const res = await fetch(`https://olimpollo-api.onrender.com/api/clientes/exacto/${tel}`);
                    if (res.ok) {
                        const cliente = await res.json();
                        inputClienteNombre.value = cliente.nombre;
                        infoClienteCRM.style.display = 'block';
                        infoClienteCRM.innerHTML = `üåü ¬°Cliente Frecuente!<br>Visitas: ${cliente.visitas} | Puntos: ${cliente.puntos}`;
                        infoClienteCRM.style.color = '#27ae60';
                    } else {
                        infoClienteCRM.style.display = 'block';
                        infoClienteCRM.innerHTML = `üÜï Cliente Nuevo (Se registrar√° al finalizar)`;
                        infoClienteCRM.style.color = '#7f8c8d';
                        inputClienteNombre.focus();
                    }
                } catch (e) { console.error(e); }
            });

            // --- Selectores ---
            canalBotonesContainer.addEventListener('click', (e) => {
                const target = e.target.closest('.btn-selector');
                if (!target) return;
                canalBotonesContainer.querySelectorAll('.btn-selector').forEach(btn => btn.classList.remove('active'));
                target.classList.add('active');
                selectedCanal = target.dataset.canal;

                if (['Uber', 'Didi', 'Rappi'].includes(selectedCanal)) {
                    seleccionarMetodoPago('Aplicaci√≥n');
                } else if (selectedCanal === 'OyR' && selectedPago === 'Aplicaci√≥n') {
                    seleccionarMetodoPago('Efectivo');
                }
            });

            pagoBotonesContainer.addEventListener('click', (e) => {
                const target = e.target.closest('.btn-selector');
                if (!target) return;
                seleccionarMetodoPago(target.dataset.pago);
            });

            function seleccionarMetodoPago(metodo) {
                selectedPago = metodo;
                pagoBotonesContainer.querySelectorAll('.btn-selector').forEach(btn => btn.classList.remove('active'));
                const btnAActivar = Array.from(pagoBotonesContainer.children).find(btn => btn.dataset.pago === metodo);
                if (btnAActivar) btnAActivar.classList.add('active');
                
                // Recalcular para mostrar/ocultar info de comisi√≥n
                calcularTotal();
            }

            // --- Carrito ---
            const renderProductos = (productos) => {
                 const categoryColors = {'Platos Fuertes':'#F8D9D9','Sides':'#FCF3CF','Bebidas':'#DDDDDD','PROMOS':'#D5F5E3','Aderezos':'#E5E7E9','default':'#F2F3F4'};
                menuContainer.innerHTML = '';
                productos.forEach(producto => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-producto';
                    btn.dataset.id = producto.id;
                    btn.dataset.precio = producto.precio_base;
                    btn.dataset.nombre = producto.nombre_venta;
                    btn.dataset.gruposModificadores = producto.grupos_modificadores || '';
                    btn.textContent = `${producto.nombre_venta} ($${producto.precio_base.toFixed(2)})`;
                    btn.style.backgroundColor = categoryColors[producto.categoria] || categoryColors['default'];
                    if (producto.grupos_modificadores) btn.style.border = '3px solid #007bff';
                    menuContainer.appendChild(btn);
                });
            };

            const manejarClickProducto = async (e) => {
                const target = e.target.closest('.btn-producto');
                if (!target) return;
                const productoSeleccionado = target.dataset;
                const gruposModificadoresStr = productoSeleccionado.gruposModificadores || '';
                const gruposAplicables = gruposModificadoresStr.split(',').map(g => g.trim()).filter(Boolean);
                let modificadoresAcumulados = [];
                let precioAdicionalTotal = 0;
                try {
                    for (const nombreGrupo of gruposAplicables) {
                        const opciones = menuData.opciones[nombreGrupo] || [];
                        if (opciones.length === 0) continue;
                        const titulo = `Selecciona ${nombreGrupo} para ${productoSeleccionado.nombre}`;
                        const seleccion = await solicitarOpcion(titulo, opciones);
                        modificadoresAcumulados.push(seleccion);
                        precioAdicionalTotal += seleccion.precio_adicional;
                    }
                    agregarItemAlCarrito(productoSeleccionado, modificadoresAcumulados, precioAdicionalTotal);
                } catch (error) { console.log(error.message); }
            };

            const agregarItemAlCarrito = (producto, modificadoresAcumulados, precioAdicionalTotal) => {
                const item = { menu_producto_id: parseInt(producto.id), nombre_venta: producto.nombre, precio_unitario: parseFloat(producto.precio) + precioAdicionalTotal, cantidad: 1, modificadores: modificadoresAcumulados.map(m => m.valor).join(', '), notas: '' };
                carrito.push(item);
                renderCarrito();
            };

            const renderCarrito = () => {
                listaCarrito.innerHTML = '';
                if (carrito.length === 0) {
                    listaCarrito.innerHTML = '<li style="color: var(--secondary-text);">A√∫n no hay productos.</li>';
                    calcularTotal();
                    return;
                }
                carrito.forEach((item, index) => {
                    const li = document.createElement('li');
                    const mods = item.modificadores ? `(${item.modificadores})` : '';
                    const notaHTML = item.notas ? `<span class="item-nota">üìù ${item.notas}</span>` : '';
                    li.innerHTML = `
                        <div style="flex: 1;">
                            <strong>${item.cantidad}x ${item.nombre_venta}</strong>
                            <span style="font-size: 14px; display: block; color: var(--secondary-text);">${mods}</span>
                            ${notaHTML}
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px; margin-left: 10px;">
                            <span style="font-weight:600; min-width:60px; text-align:right;">$${(item.precio_unitario * item.cantidad).toFixed(2)}</span>
                            <button class="btn-item-action btn-nota" data-index="${index}" title="Agregar Nota">‚úèÔ∏è</button>
                            <button class="btn-item-action btn-duplicar" data-index="${index}" title="Duplicar">‚ûï</button>
                            <button class="btn-item-action btn-eliminar" data-index="${index}" title="Eliminar">‚ùå</button>
                        </div>`;
                    listaCarrito.appendChild(li);
                });
                calcularTotal();
            };
            
            listaCarrito.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const index = parseInt(target.dataset.index, 10);
                if (target.classList.contains('btn-eliminar')) { carrito.splice(index, 1); renderCarrito(); } 
                else if (target.classList.contains('btn-duplicar')) { const newItem = JSON.parse(JSON.stringify(carrito[index])); carrito.splice(index + 1, 0, newItem); renderCarrito(); } 
                else if (target.classList.contains('btn-nota')) { const n = prompt("Nota:", carrito[index].notas || ''); if (n !== null) { carrito[index].notas = n.trim(); renderCarrito(); } }
            });

            formFinalizarPedido.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (carrito.length === 0) return alert('El carrito est√° vac√≠o.');
                const totalAjustado = inputAjusteTotal.value;
                if (selectedCanal !== 'OyR' && !totalAjustado) { alert('Para Apps, ingresa el total exacto del ticket.'); inputAjusteTotal.focus(); return; }
                const totalCalculado = calcularTotal(false); 
                let totalFinal = inputAjusteTotal.value ? parseFloat(inputAjusteTotal.value) : totalCalculado;
                
                const pedidoData = { cliente: inputClienteNombre.value.trim(), telefono: inputTelefono.value.trim(), canal_venta: selectedCanal, metodo_pago: selectedPago, total_ajustado: totalFinal, items: carrito.map(item => ({ menu_producto_id: item.menu_producto_id, nombre_producto_completo: item.nombre_venta + (item.modificadores ? ` (${item.modificadores})` : ''), cantidad: item.cantidad, precio_unitario: item.precio_unitario, notas: item.notas })) };

                try {
                    const response = await fetch(API_PEDIDOS_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(pedidoData) });
                    if (!response.ok) throw new Error('Error al guardar.');
                    const data = await response.json();
                    
                    let msg = `‚úÖ Pedido #${data.id} guardado.`;
                    if (data.comision && parseFloat(data.comision) > 0) {
                        msg += `\n(Se descont√≥ comisi√≥n: $${data.comision})`;
                    }
                    alert(msg);
                    
                    carrito = []; formFinalizarPedido.reset(); infoClienteCRM.style.display = 'none';
                    seleccionarMetodoPago('Efectivo'); canalBotonesContainer.querySelector('[data-canal="OyR"]').click();
                    renderCarrito();
                } catch (error) { alert(`‚ùå Error: ${error.message}`); }
            });

            // --- C√°lculos Inteligentes ---
            const calcularTotal = (updateUI = true) => {
                const totalCarrito = carrito.reduce((sum, item) => sum + (item.precio_unitario * item.cantidad), 0);
                const totalManual = parseFloat(inputAjusteTotal.value);
                const totalReal = (totalManual && totalManual > 0) ? totalManual : totalCarrito;

                if (updateUI) {
                    if (!totalManual) {
                        totalPedidoSpan.textContent = `$${totalCarrito.toFixed(2)}`;
                    } else {
                        totalPedidoSpan.textContent = `$${totalReal.toFixed(2)} (Manual)`;
                    }
                    
                    infoComision.style.display = 'block'; 

                    if (totalReal > 0) {
                        if (selectedPago === 'Tarjeta') {
                            // Tarjeta: Calcula directo (sobre carrito o manual)
                            const comision = totalReal * 0.04176; 
                            const neto = totalReal - comision;
                            infoComision.innerHTML = `Cobras: <strong>$${totalReal.toFixed(2)}</strong> | Recibes: <strong style="color: #27ae60;">$${neto.toFixed(2)}</strong> <span style="font-size:12px; color:#e74c3c;">(-3.6%+IVA)</span>`;
                        } else if (selectedPago === 'Aplicaci√≥n') {
                            // Apps: L√≥gica condicional
                            if (!totalManual) {
                                // ‚ö†Ô∏è Si es App y NO hay manual: Advertencia
                                infoComision.innerHTML = `<span style="color: #e67e22; font-weight: 600; background: #fdf2e9; padding: 6px; border-radius: 4px; border: 1px solid #e67e22; display:block; text-align:center;">‚ö†Ô∏è Por favor ingresa el total ajustado del ticket</span>`;
                            } else {
                                // ‚úÖ Si es App y HAY manual: Muestra c√°lculo
                                const comision = totalReal * 0.4213; 
                                const neto = totalReal - comision;
                                infoComision.innerHTML = `Venta App: <strong>$${totalReal.toFixed(2)}</strong> | Recibes: <strong style="color: #27ae60;">$${neto.toFixed(2)}</strong> <span style="font-size:12px; color:#e74c3c;">(-42.13%)</span>`;
                            }
                        } else {
                            // Efectivo / Transferencia
                            infoComision.style.display = 'none';
                        }
                    } else {
                        infoComision.style.display = 'none';
                    }
                }
                return totalCarrito;
            };
            
            // Escuchar cambios en el input manual para recalcular al instante
            inputAjusteTotal.addEventListener('input', () => calcularTotal(true));

            // Modal Helpers
            const modalModTitulo = document.getElementById('modal-mod-titulo');
            const modalModOpciones = document.getElementById('modal-mod-opciones');
            const modalModificadores = document.getElementById('modalModificadores');
            const btnCancelarMod = document.getElementById('btn-cancelar-mod');
            const solicitarOpcion = (titulo, opciones) => {
                return new Promise((resolve, reject) => {
                    modalModTitulo.textContent = titulo; modalModOpciones.innerHTML = '';
                    const cleanup = () => { modalModificadores.style.display = 'none'; modalModOpciones.innerHTML = ''; };
                    opciones.forEach(opcion => {
                        const btn = document.createElement('button'); btn.className = 'btn-modificador';
                        btn.textContent = `${opcion.valor} ${opcion.precio_adicional > 0 ? `(+$${opcion.precio_adicional.toFixed(2)})` : ''}`;
                        btn.onclick = () => { cleanup(); resolve(opcion); }; modalModOpciones.appendChild(btn);
                    });
                    btnCancelarMod.onclick = () => { cleanup(); reject(new Error('Selecci√≥n cancelada.')); };
                    modalModificadores.style.display = 'flex';
                });
            };

            const cargarMenuPOS = async () => { try { const r = await fetch(API_MENU_URL); const d = await r.json(); menuData = d; renderProductos(d.productos); } catch (e) { menuContainer.innerHTML = 'Error cargando men√∫'; } };
            const token = localStorage.getItem('authToken'); if(token) { const u = parseJwt(token); if(u) document.getElementById('user-identifier').textContent = u.username; } else window.location.href = 'login.html';
            document.getElementById('btn-logout').addEventListener('click', () => {localStorage.clear(); window.location.href='login.html'});

            menuContainer.addEventListener('click', manejarClickProducto);
            cargarMenuPOS();
        });
    </script>
</body>
</html>
