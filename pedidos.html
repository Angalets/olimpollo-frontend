<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Olimpollo - Punto de Venta</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  
    <style>
        /* ==========================================================================
           BASE DE ESTILOS UNIFICADA PARA OLIMPOLLO
           ========================================================================== */
        :root{--bg-main:#ECF0F1;--bg-header:#FFFFFF;--card-bg:#FFFFFF;--primary-text:#502c2c;--secondary-text:#808B96;--accent-color:#db3434;--accent-hover:#b92929;--border-color:#D5D8DC;--shadow-light:0 4px 15px rgba(0, 0, 0, 0.08);--shadow-heavy:0 10px 20px rgba(0, 0, 0, 0.12);}body{margin:0;font-family:'Poppins', sans-serif;background-color:var(--bg-main);color:var(--primary-text);display:flex;flex-direction:column;min-height:100vh;}header{background:var(--bg-header);padding:15px 40px;box-shadow:0 2px 10px rgba(0, 0, 0, 0.05);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);}header .logo{font-size:24px;font-weight:600;text-decoration:none;color:var(--primary-text);}header nav{display:flex;gap:20px;}header nav a{text-decoration:none;color:var(--secondary-text);font-weight:500;transition:color 0.3s;}header nav a:hover{color:var(--accent-color);}.user-info{display:flex;align-items:center;gap:20px;}#user-identifier{font-weight:500;background-color:var(--bg-main);padding:5px 12px;border-radius:15px;font-size:14px;}.logout{background:var(--accent-color);color:white;border:none;padding:8px 18px;border-radius:20px;cursor:pointer;font-size:14px;font-weight:500;transition:background-color 0.3s;}.logout:hover{background-color:var(--accent-hover);}main{flex:1;padding:40px;max-width:1400px;margin:0 auto;width:100%;box-sizing:border-box;}h1, h2, h3{margin-top:0;}h2.page-title{margin-bottom:30px;font-size:28px;font-weight:600;}.card{background:var(--card-bg);border-radius:12px;padding:25px;box-shadow:var(--shadow-light);margin-bottom:25px;}table{width:100%;border-collapse:collapse;background:var(--card-bg);border-radius:12px;overflow:hidden;box-shadow:var(--shadow-light);}th, td{padding:15px;text-align:left;border-bottom:1px solid var(--bg-main);}th{font-weight:600;font-size:14px;text-transform:uppercase;color:var(--secondary-text);background-color:#F8F9F9;}tr:hover{background-color:#FDF2F2;}.btn{border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:500;font-family:'Poppins', sans-serif;transition:background-color 0.3s, transform 0.2s;}.btn:hover{transform:translateY(-2px);}.btn-primary{background-color:var(--accent-color);color:white;}.btn-primary:hover{background-color:var(--accent-hover);}.btn-secondary{background-color:var(--secondary-text);color:white;}.btn-secondary:hover{background-color:#6C7A89;}.btn-danger{background-color:#E74C3C;color:white;}.btn-success{background-color:#2ECC71;color:white;}label{display:block;margin-bottom:8px;font-weight:500;font-size:14px;}input[type="text"],input[type="password"],input[type="number"],input[type="date"],select,textarea{width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;font-family:'Poppins', sans-serif;font-size:14px;box-sizing:border-box;transition:border-color 0.3s, box-shadow 0.3s;}input:focus, select:focus, textarea:focus{outline:none;border-color:var(--accent-color);box-shadow:0 0 0 3px rgba(219, 52, 52, 0.1);}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);justify-content:center;align-items:center;}.modal-content{background:var(--card-bg);padding:30px;border-radius:12px;box-shadow:var(--shadow-heavy);width:90%;max-width:500px;position:relative;}.close{position:absolute;top:15px;right:20px;font-size:28px;cursor:pointer;color:var(--secondary-text);}footer{text-align:center;padding:20px;font-size:14px;color:var(--secondary-text);}

        /* ==========================================================================
           ESTILOS ESPEC√çFICOS PARA LA P√ÅGINA DE POS
           ========================================================================== */
        .pos-container { display: flex; gap: 25px; align-items: flex-start; }
        .menu-area { flex: 2; }
        .carrito-card { flex: 1; position: sticky; top: 40px; }
        .productos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
        .btn-producto { width: 100%; aspect-ratio: 1 / 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; border: 1px solid var(--border-color); padding: 10px; color: var(--primary-text); border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: background 0.2s, transform 0.2s; word-wrap: break-word; }
        .btn-producto:hover { transform: translateY(-4px); }
        .carrito-list { list-style: none; padding: 0; margin: 0 0 20px 0; max-height: 300px; overflow-y: auto; }
        .carrito-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--bg-main); }
        .btn-modificador { width: 100%; padding: 15px; font-size: 16px; font-weight: bold; cursor: pointer; border: 1px solid #ddd; background: #f9f9f9; border-radius: 5px; transition: background 0.2s; }
        .btn-modificador:hover { background: #FCF3CF; }
        .btn-item-action { background: #007bff; color: white; border: none; padding: 3px 8px; font-size: 14px; cursor: pointer; border-radius: 4px; }
        .btn-item-action:hover { opacity: 0.8; }
        
        /* --- üö® NUEVOS ESTILOS PARA BOTONES DE CANAL --- */
        .canal-botones-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .btn-canal { padding: 12px 5px; border: 2px solid var(--border-color); background-color: transparent; color: var(--secondary-text); border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s ease-in-out; }
        .btn-canal.active { background-color: var(--accent-color); color: white; border-color: var(--accent-color); transform: scale(1.05); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">Olimpollo</a>
        <nav>
          <a href="pedidos.html">POS</a>
          <a href="reportes.html">Reportes</a>
          <a href="pedidos_lista.html">Pedidos</a>
          <a href="inventario.html">Inventario</a>
          <a href="recetas.html">Recetas</a>
        </nav>
        <div class="user-info">
            <span id="user-identifier"></span>
            <button class="logout" id="btn-logout">Cerrar Sesi√≥n</button>
        </div>
    </header>

    <main>
        <h2 class="page-title">Punto de Venta (POS)</h2>
        <div class="pos-container">
            <div class="menu-area">
                <div id="productos-container" class="productos-grid card">
                    <p>Cargando men√∫...</p>
                </div>
            </div>

            <div class="carrito-card card">
                <h3>Carrito de Pedido</h3>
                <ul id="lista-carrito" class="carrito-list">
                    <li style="color: var(--secondary-text);">A√∫n no hay productos.</li>
                </ul>
                <div style="font-size: 20px; font-weight: bold; border-top: 2px solid var(--accent-color); padding-top: 15px; margin-bottom: 20px;">
                    Total: <span id="total-pedido">$0.00</span>
                </div>
                
                <form id="form-finalizar-pedido">
                    <div style="margin-bottom: 15px;">
                        <label>Canal de Venta:</label>
                        <div id="canal-venta-botones" class="canal-botones-container">
                            <button type="button" class="btn-canal active" data-canal="OyR">OyR</button>
                            <button type="button" class="btn-canal" data-canal="Uber">Uber</button>
                            <button type="button" class="btn-canal" data-canal="Didi">Didi</button>
                            <button type="button" class="btn-canal" data-canal="Rappi">Rappi</button>
                            <button type="button" class="btn-canal" data-canal="Empleado">Empleado</button>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="cliente-nombre">Nombre del Cliente:</label>
                        <input type="text" id="cliente-nombre" placeholder="Nombre del cliente" required>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label for="ajuste-total" style="color: var(--accent-color);">Total Recibido/Ajustado ($):</label>
                        <input type="number" id="ajuste-total" placeholder="Opcional para OyR" min="0" step="0.01">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 16px;">
                        FINALIZAR PEDIDO
                    </button>
                </form>
            </div>
        </div>
    </main>

    <div id="modalModificadores" class="modal">
        <div class="modal-content">
            <h3 id="modal-mod-titulo">Seleccionar Opci√≥n</h3>
            <div id="modal-mod-opciones" style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;"></div>
            <button id="btn-cancelar-mod" class="btn btn-secondary" style="margin-top: 20px;">Cancelar</button>
        </div>
    </div>

    <footer>&copy; 2025 Los Boneless del Olimpo</footer>

    <script>
        function parseJwt(token) { try { const base64Url = token.split('.')[1]; const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/'); const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); return JSON.parse(jsonPayload); } catch (e) { return null; } }

        document.addEventListener('DOMContentLoaded', () => {
            const API_MENU_URL = 'https://olimpollo-api.onrender.com/api/menu/pos';
            const API_PEDIDOS_URL = 'https://olimpollo-api.onrender.com/api/pedidos';
            let menuData = { productos: [], opciones: {} };
            let carrito = [];
            let selectedCanal = 'OyR'; // üö® CAMBIO: Variable para guardar el canal

            const menuContainer = document.getElementById('productos-container');
            const listaCarrito = document.getElementById('lista-carrito');
            const totalPedidoSpan = document.getElementById('total-pedido');
            const formFinalizarPedido = document.getElementById('form-finalizar-pedido');
            const inputClienteNombre = document.getElementById('cliente-nombre');
            const canalBotonesContainer = document.getElementById('canal-venta-botones'); // üö® CAMBIO: Apunta al contenedor de botones
            const inputAjusteTotal = document.getElementById('ajuste-total');
            const modalModificadores = document.getElementById('modalModificadores');
            const modalModTitulo = document.getElementById('modal-mod-titulo');
            const modalModOpciones = document.getElementById('modal-mod-opciones');
            const btnCancelarMod = document.getElementById('btn-cancelar-mod');

            const solicitarOpcion = (titulo, opciones) => { /* ... (c√≥digo sin cambios) ... */ };
            const manejarClickProducto = async (e) => { /* ... (c√≥digo sin cambios) ... */ };
            const agregarItemAlCarrito = (producto, modificadoresAcumulados, precioAdicionalTotal) => { /* ... (c√≥digo sin cambios) ... */ };
            const calcularTotal = () => { /* ... (c√≥digo sin cambios) ... */ };
            const cerrarSesion = () => { /* ... (c√≥digo sin cambios) ... */ };
            const renderProductos = (productos) => { /* ... (c√≥digo sin cambios) ... */ };
            const cargarMenuPOS = async () => { /* ... (c√≥digo sin cambios) ... */ };

            const finalizarPedido = async (e) => {
                e.preventDefault();
                if (carrito.length === 0) return alert('El carrito est√° vac√≠o.');

                const totalAjustado = inputAjusteTotal.value;
                if (selectedCanal !== 'OyR' && !totalAjustado) {
                    alert('Para canales como Uber, Didi o Rappi, es obligatorio ingresar el "Total Recibido/Ajustado".');
                    inputAjusteTotal.focus();
                    return;
                }
                const totalCalculado = calcularTotal();
                let totalFinal = inputAjusteTotal.value ? parseFloat(inputAjusteTotal.value) : totalCalculado;
                if (isNaN(totalFinal) || totalFinal < 0) return alert('El total ajustado no es v√°lido.');
                const pedidoData = { cliente: inputClienteNombre.value.trim(), canal_venta: selectedCanal, total_ajustado: totalFinal, items: carrito.map(item => ({ menu_producto_id: item.menu_producto_id, nombre_producto_completo: item.nombre_venta + (item.modificadores ? ` (${item.modificadores})` : ''), cantidad: item.cantidad, precio_unitario: item.precio_unitario })) };

                try {
                    const response = await fetch(API_PEDIDOS_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(pedidoData) });
                    if (!response.ok) throw new Error('Error al guardar el pedido.');
                    const data = await response.json();
                    alert(`‚úÖ Pedido #${data.id} guardado con √©xito.`);
                    carrito = [];
                    formFinalizarPedido.reset();
                    inputAjusteTotal.value = '';
                    
                    // üö® CAMBIO: Resetear los botones al estado inicial
                    canalBotonesContainer.querySelectorAll('.btn-canal').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.dataset.canal === 'OyR') btn.classList.add('active');
                    });
                    selectedCanal = 'OyR';
                    
                    renderCarrito();
                } catch (error) {
                    alert(`‚ùå Fallo al finalizar el pedido: ${error.message}`);
                }
            };
            
            const renderCarrito = () => { /* ... (c√≥digo sin cambios) ... */ };

            // --- PEGAR C√ìDIGO COMPLETO DE FUNCIONES (para brevedad) ---
            const solicitarOpcion=async(t,e)=>new Promise((o,n)=>{modalModTitulo.textContent=t,modalModOpciones.innerHTML="";const a=()=>{modalModificadores.style.display="none",modalModOpciones.innerHTML=""};e.forEach(t=>{const e=document.createElement("button");e.className="btn-modificador",e.textContent=`${t.valor} ${t.precio_adicional>0?`(+$${t.precio_adicional.toFixed(2)})`:""}`,e.onclick=()=>{a(),o(t)},modalModOpciones.appendChild(e)}),btnCancelarMod.onclick=()=>{a(),n(new Error("Selecci√≥n cancelada."))},modalModificadores.style.display="flex"});
            const manejarClickProducto=async t=>{const e=t.target.closest(".btn-producto");if(!e)return;const o=e.dataset,n=o.gruposModificadores||"",a=n.split(",").map(t=>t.trim()).filter(Boolean);let d=[],i=0;try{for(const t of a){const e=menuData.opciones[t]||[];if(0===e.length)continue;const n=`Selecciona ${t} para ${o.nombre}`,l=await solicitarOpcion(n,e);d.push(l),i+=l.precio_adicional}agregarItemAlCarrito(o,d,i)}catch(t){console.log(t.message)}};
            const agregarItemAlCarrito=(t,e,o)=>{const n={menu_producto_id:parseInt(t.id),nombre_venta:t.nombre,precio_unitario:parseFloat(t.precio)+o,cantidad:1,modificadores:e.map(t=>t.valor).join(", ")};carrito.push(n),renderCarrito()};
            const calcularTotal=()=>{const t=carrito.reduce((t,e)=>t+e.precio_unitario*e.cantidad,0);return totalPedidoSpan.textContent=`$${t.toFixed(2)}`,t};
            const cerrarSesion=()=>{localStorage.removeItem("authToken"),localStorage.removeItem("userRole"),window.location.href="login.html"};
            const renderProductos=t=>{const e={"Platos Fuertes":"#F8D9D9",Sides:"#FCF3CF",Bebidas:"#DDDDDD",PROMOS:"#D5F5E3",Aderezos:"#E5E7E9",default:"#F2F3F4"};menuContainer.innerHTML="",t.forEach(t=>{const o=document.createElement("button");o.className="btn-producto",o.dataset.id=t.id,o.dataset.precio=t.precio_base,o.dataset.nombre=t.nombre_venta,o.dataset.gruposModificadores=t.grupos_modificadores||"",o.textContent=`${t.nombre_venta} ($${t.precio_base.toFixed(2)})`;const n=e[t.categoria]||e.default;o.style.backgroundColor=n,t.grupos_modificadores&&(o.style.border="3px solid #007bff"),menuContainer.appendChild(o)})};
            const cargarMenuPOS=async()=>{try{const t=await fetch(API_MENU_URL);if(!t.ok)throw new Error("Error al cargar el men√∫.");menuData=await t.json(),renderProductos(menuData.productos)}catch(t){menuContainer.innerHTML=`<p style="color:red;">Error: ${t.message}</p>`}};
            const renderCarrito=()=>{listaCarrito.innerHTML="",0===carrito.length?(listaCarrito.innerHTML='<li style="color: var(--secondary-text);">A√∫n no hay productos.</li>',calcularTotal()):(carrito.forEach((t,e)=>{const o=document.createElement("li"),n=t.modificadores?`(${t.modificadores})`:"";o.innerHTML=`<div><strong>${t.cantidad}x ${t.nombre_venta}</strong><span style="font-size: 14px; display: block; color: var(--secondary-text);">${n}</span></div><div style="display: flex; align-items: center; gap: 8px;"><span>$${(t.precio_unitario*t.cantidad).toFixed(2)}</span><button class="btn-item-action btn-duplicar-item" data-index="${e}" title="Duplicar Item" style="background-color: #007bff;">&#10133;</button><button class="btn-item-action btn-eliminar-item" data-index="${e}" title="Eliminar Item" style="background-color: var(--secondary-text);">&times;</button></div>`,listaCarrito.appendChild(o)}),calcularTotal())};

            // --- INICIALIZACI√ìN Y LISTENERS ---
            const token = localStorage.getItem('authToken');
            if(token) {
                const userData = parseJwt(token);
                if (userData && userData.username) document.getElementById('user-identifier').textContent = userData.username;
            } else {
                window.location.href = 'login.html';
            }
            
            document.getElementById('btn-logout').addEventListener('click', cerrarSesion);
            menuContainer.addEventListener('click', manejarClickProducto);
            
            // üö® CAMBIO: Listener para los botones de canal
            canalBotonesContainer.addEventListener('click', (e) => {
                const target = e.target.closest('.btn-canal');
                if (!target) return;
                canalBotonesContainer.querySelectorAll('.btn-canal').forEach(btn => btn.classList.remove('active'));
                target.classList.add('active');
                selectedCanal = target.dataset.canal;
            });

            listaCarrito.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const index = parseInt(target.dataset.index, 10);
                if (target.classList.contains('btn-eliminar-item')) {
                    carrito.splice(index, 1);
                    renderCarrito();
                } else if (target.classList.contains('btn-duplicar-item')) {
                    const itemToDuplicate = carrito[index];
                    const newItem = JSON.parse(JSON.stringify(itemToDuplicate));
                    carrito.splice(index + 1, 0, newItem);
                    renderCarrito();
                }
            });
            
            formFinalizarPedido.addEventListener('submit', finalizarPedido);
            
            cargarMenuPOS();
            renderCarrito();
        });
    </script>
</body>
</html>
