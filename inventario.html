<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Olimpollo - Inventario</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* ==========================================================================
           BASE DE ESTILOS UNIFICADA PARA OLIMPOLLO
           ========================================================================== */
        :root{--bg-main:#ECF0F1;--bg-header:#FFFFFF;--card-bg:#FFFFFF;--primary-text:#502c2c;--secondary-text:#808B96;--accent-color:#db3434;--accent-hover:#b92929;--border-color:#D5D8DC;--shadow-light:0 4px 15px rgba(0, 0, 0, 0.08);--shadow-heavy:0 10px 20px rgba(0, 0, 0, 0.12);}body{margin:0;font-family:'Poppins', sans-serif;background-color:var(--bg-main);color:var(--primary-text);display:flex;flex-direction:column;min-height:100vh;}header{background:var(--bg-header);padding:15px 40px;box-shadow:0 2px 10px rgba(0, 0, 0, 0.05);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);}header .logo{font-size:24px;font-weight:600;text-decoration:none;color:var(--primary-text);}header nav{display:flex;gap:20px;}header nav a{text-decoration:none;color:var(--secondary-text);font-weight:500;transition:color 0.3s;}header nav a:hover{color:var(--accent-color);}.user-info{display:flex;align-items:center;gap:20px;}#user-identifier{font-weight:500;background-color:var(--bg-main);padding:5px 12px;border-radius:15px;font-size:14px;}.logout{background:var(--accent-color);color:white;border:none;padding:8px 18px;border-radius:20px;cursor:pointer;font-size:14px;font-weight:500;transition:background-color 0.3s;}.logout:hover{background-color:var(--accent-hover);}main{flex:1;padding:40px;max-width:1400px;margin:0 auto;width:100%;box-sizing:border-box;}h1, h2, h3{margin-top:0;}h2.page-title{margin-bottom:30px;font-size:28px;font-weight:600;}.card{background:var(--card-bg);border-radius:12px;padding:25px;box-shadow:var(--shadow-light);margin-bottom:25px;}table{width:100%;border-collapse:collapse;background:var(--card-bg);border-radius:12px;overflow:hidden;box-shadow:var(--shadow-light);}th, td{padding:15px;text-align:left;border-bottom:1px solid var(--bg-main);}th{font-weight:600;font-size:14px;text-transform:uppercase;color:var(--secondary-text);background-color:#F8F9F9;}tr:hover{background-color:#FDF2F2;}.btn{border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:500;font-family:'Poppins', sans-serif;transition:background-color 0.3s, transform 0.2s;}.btn:hover{transform:translateY(-2px);}.btn-primary{background-color:var(--accent-color);color:white;}.btn-primary:hover{background-color:var(--accent-hover);}.btn-secondary{background-color:var(--secondary-text);color:white;}.btn-secondary:hover{background-color:#6C7A89;}.btn-danger{background-color:#E74C3C;color:white;}.btn-success{background-color:#2ECC71;color:white;}label{display:block;margin-bottom:8px;font-weight:500;font-size:14px;}input[type="text"],input[type="password"],input[type="number"],input[type="date"],select,textarea{width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;font-family:'Poppins', sans-serif;font-size:14px;box-sizing:border-box;transition:border-color 0.3s, box-shadow 0.3s;}input:focus, select:focus, textarea:focus{outline:none;border-color:var(--accent-color);box-shadow:0 0 0 3px rgba(219, 52, 52, 0.1);}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);justify-content:center;align-items:center;}.modal-content{background:var(--card-bg);padding:30px;border-radius:12px;box-shadow:var(--shadow-heavy);width:90%;max-width:500px;position:relative;}.close{position:absolute;top:15px;right:20px;font-size:28px;cursor:pointer;color:var(--secondary-text);}footer{text-align:center;padding:20px;font-size:14px;color:var(--secondary-text);}

        /* Estilos espec√≠ficos para esta p√°gina */
        .action-bar { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; }
        .filtros-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; align-items: flex-end; }
        #notificacion { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: var(--accent-color); color: white; padding: 15px 25px; border-radius: 8px; box-shadow: var(--shadow-heavy); z-index: 2000; display: none; }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">Olimpollo</a>
        <nav>
          <a href="pedidos.html">POS</a>
          <a href="reportes.html">Reportes</a>
          <a href="pedidos_lista.html">Pedidos</a>
          <a href="inventario.html">Inventario</a>
          <a href="recetas.html">Recetas</a>
        </nav>
        <div class="user-info">
            <span id="user-identifier"></span>
            <button class="logout" id="btn-logout">Cerrar Sesi√≥n</button>
        </div>
    </header>

    <main>
        <h2 class="page-title">Gesti√≥n de Inventario</h2>
        
        <div class="action-bar">
            <button id="btn-agregar" class="btn btn-primary">‚ûï Agregar Nuevo Insumo</button>
            <button id="btn-guardar-corte" class="btn btn-secondary">üíæ Guardar Inventario F√≠sico</button>
        </div>

        <div class="card">
            <div class="filtros-grid">
                <div>
                    <label for="filtro-categoria">Filtrar por Categor√≠a:</label>
                    <select id="filtro-categoria">
                        <option value="">-- Todas --</option>
                        <option value="Materia Prima">Materia Prima</option>
                        <option value="Salsas">Salsas</option>
                        <option value="Aderezos">Aderezos</option>
                        <option value="Aceite">Aceite</option>
                        <option value="Bebidas">Bebidas</option>
                        <option value="Empacado">Empacado</option>
                        <option value="Gases">Gas</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
                <div>
                    <label for="filtro-estado">Filtrar por Alerta:</label>
                    <select id="filtro-estado">
                        <option value="">-- Todas --</option>
                        <option value="En stock">En Stock</option>
                        <option value="Requiere re-stock">Stock Bajo</option>
                        <option value="Agotado">Agotado</option>
                    </select>
                </div>
                <button id="btn-aplicar-filtro" class="btn btn-primary">Aplicar Filtro</button>
            </div>
        </div>

        <table id="tabla-inventario">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Categor√≠a</th>  
                    <th>Cantidad</th>
                    <th>Unidad</th>       
                    <th>Estado</th>       
                    <th>Acciones</th>
                </tr>
            </thead>    
            <tbody></tbody>
        </table>
    </main>

    <div id="modalProducto" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Agregar Nuevo Insumo</h3>
            <form id="form-agregar" style="display: grid; gap: 15px;">
                <div>
                    <label for="nombre-agregar">Nombre del Insumo:</label>
                    <input type="text" id="nombre-agregar" required>
                </div>
                <div>
                    <label for="categoria-agregar">Categor√≠a:</label>
                    <select id="categoria-agregar" required>
                        <option value="Materia Prima">Materia Prima</option>
                        <option value="Salsas">Salsas</option>
                        <option value="Aderezos">Aderezos</option>
                        <option value="Aceite">Aceite</option>
                        <option value="Bebidas">Bebidas</option>
                        <option value="Empacado">Empacado</option>
                        <option value="Gases">Gas</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
                <div>
                    <label for="cantidad-agregar">Cantidad Inicial:</label>
                    <input type="number" id="cantidad-agregar" min="0" value="0" required>
                </div>
                <div>
                    <label for="unidad-agregar">Unidad de Medida (Ej: Kg, Pz, L):</label>
                    <input type="text" id="unidad-agregar" value="Unidad" required>
                </div>
                <div>
                    <label for="stock-minimo-agregar">Stock M√≠nimo (Alerta):</label>
                    <input type="number" id="stock-minimo-agregar" min="0" value="10" required>
                </div>
                <button type="submit" class="btn btn-primary">Guardar Insumo</button>
            </form>
        </div>
    </div>

    <div id="modalEditar" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Editar Insumo</h3>
            <form id="form-editar" style="display: grid; gap: 15px;">
                <input type="hidden" id="edit-id">
                <div>
                    <label>ID Producto:</label>
                    <input type="text" id="edit-id-display" readonly disabled>
                </div>
                <div>
                    <label for="edit-nombre">Nombre:</label>
                    <input type="text" id="edit-nombre" required>
                </div>
                <div>
                    <label for="edit-categoria">Categor√≠a:</label>
                    <select id="edit-categoria" required>
                        <option value="Materia Prima">Materia Prima</option>
                        <option value="Salsas">Salsas</option>
                        <option value="Aderezos">Aderezos</option>
                        <option value="Aceite">Aceite</option>
                        <option value="Bebidas">Bebidas</option>
                        <option value="Empacado">Empacado</option>
                        <option value="Gases">Gas</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
                <div>
                    <label for="edit-cantidad">Cantidad:</label>
                    <input type="number" id="edit-cantidad" min="0" required>
                </div>
                <div>
                    <label for="edit-unidad">Unidad de Medida:</label>
                    <input type="text" id="edit-unidad" required>
                </div>
                <div>
                    <label for="edit-stock-minimo">Stock M√≠nimo (Alerta):</label>
                    <input type="number" id="edit-stock-minimo" min="0" required>
                </div>
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <div id="modalConfirmar" class="modal">
        <div class="modal-content" style="text-align:center;">
            <span class="close">&times;</span>
            <h3>Confirmar Eliminaci√≥n</h3>
            <p>¬øEst√°s seguro de que deseas eliminar el insumo: <strong id="insumo-a-eliminar"></strong>?</p>
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                <button id="btn-confirmar-eliminar" class="btn btn-danger">S√≠, Eliminar</button>
                <button type="button" class="btn btn-secondary btn-cancelar">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="notificacion"></div>

    <footer>&copy; 2025 Los Boneless del Olimpo</footer>

    <script>
const API_URL = 'https://olimpollo-api.onrender.com/api/inventario';
        const tablaBody = document.querySelector('#tabla-inventario tbody');
        
        // Elementos para filtros
        const filtroCategoria = document.getElementById('filtro-categoria');
        const filtroEstado = document.getElementById('filtro-estado');
        const btnAplicarFiltro = document.getElementById('btn-aplicar-filtro');

        // Bot√≥n de guardar corte
        const btnGuardarCorte = document.getElementById('btn-guardar-corte');
        
        // Modales y Forms
        const modalProducto = document.getElementById('modalProducto');
        const modalEditar = document.getElementById('modalEditar');
        const modalConfirmar = document.getElementById('modalConfirmar');
        const insumoAEliminar = document.getElementById('insumo-a-eliminar');
        const formAgregar = document.getElementById('form-agregar');
        const formEditar = document.getElementById('form-editar');
        const btnConfirmarEliminar = document.getElementById('btn-confirmar-eliminar');
        
        let productoIdActual = null; // Para guardar el ID a eliminar

        // --- 1. FUNCIONES DE UTILIDAD (Modales y Notificaci√≥n) ---

        const abrirModal = (modal) => { modal.style.display = 'flex'; };
        const cerrarModales = () => {
            modalProducto.style.display = 'none';
            modalEditar.style.display = 'none';
            modalConfirmar.style.display = 'none';
        };
        const mostrarNotificacion = (mensaje) => {
            const notificacion = document.getElementById('notificacion');
            notificacion.textContent = mensaje;
            notificacion.style.display = 'block';
            setTimeout(() => { notificacion.style.display = 'none'; }, 3000);
        };

        // --- 2. FUNCIONES DE API (CRUD) ---

        const renderInventario = async () => {
            try {
                // Leer los valores de los filtros para construir la URL
                const categoria = filtroCategoria.value;
                const estado = filtroEstado.value;

                let url = API_URL + '?';
                if (categoria) {
                    url += `categoria=${encodeURIComponent(categoria)}&`;
                }
                if (estado) {
                    url += `estado=${encodeURIComponent(estado)}&`;
                }

                url = url.endsWith('&') ? url.slice(0, -1) : url;
                url = url.endsWith('?') ? url.slice(0, -1) : url;


                const token = localStorage.getItem('authToken');
                const response = await fetch(url, { // Usar la URL construida
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        alert('Sesi√≥n expirada o no autorizado. Por favor, inicia sesi√≥n de nuevo.');
                        window.location.href = 'login.html';
                        return;
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al obtener el inventario');
                }

                const inventario = await response.json();

                tablaBody.innerHTML = '';
                inventario.forEach(producto => {
                    const tr = document.createElement('tr');
                    
                    let color = '';
                    if (producto.estado === 'Agotado') {
                        color = 'background-color: #ffcccc;'; 
                    } else if (producto.estado === 'Requiere re-stock') {
                        color = 'background-color: #ffebcc;'; 
                    }
                    tr.style = color;

                    tr.innerHTML = `
                        <td>${producto.id}</td>
                        <td>${producto.nombre}</td>
                        <td>${producto.categoria}</td> 
                        <td>${producto.cantidad}</td>
                        <td>${producto.unidad}</td>  
                        <td><span style="font-weight: bold;">${producto.estado}</span></td> 
                        <td>
                            <button class="btn btn-edit" 
                                data-id="${producto.id}" 
                                data-nombre="${producto.nombre}" 
                                data-cantidad="${producto.cantidad}"
                                data-unidad="${producto.unidad}"              
                                data-stock-minimo="${producto.stock_minimo}"
                                data-categoria="${producto.categoria}"> 
                                Editar
                            </button>
                            <button class="btn btn-eliminar" data-id="${producto.id}">Eliminar</button>
                        </td>
                    `;
                    tablaBody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error al cargar el inventario:', error);
                mostrarNotificacion('Error: ' + error.message);
            }
        };

        const agregarProducto = async (data) => {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Error al agregar el insumo');
                
                await response.json(); 
                renderInventario(); 
                cerrarModales();
                mostrarNotificacion(`Insumo "${data.nombre}" agregado exitosamente.`);
            } catch (error) {
                console.error('Error al agregar:', error);
                mostrarNotificacion('Error al agregar el insumo.');
            }
        };

        const editarProducto = async (id, data) => {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_URL}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Error al editar el insumo');
                
                await response.json(); 
                renderInventario(); 
                cerrarModales();
                mostrarNotificacion(`Insumo "${data.nombre}" actualizado exitosamente.`);
            } catch (error) {
                console.error('Error al editar:', error);
                mostrarNotificacion('Error al editar el insumo.');
            }
        };

        const eliminarProducto = async (id) => {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_URL}/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.status === 409) { 
                    const data = await response.json();
                    throw new Error(data.mensaje); 
                }
                if (!response.ok) throw new Error('Error al eliminar el insumo.');
                
                renderInventario(); 
                cerrarModales();
                mostrarNotificacion('Insumo eliminado exitosamente.');
            } catch (error) {
                console.error('Error al eliminar:', error);
                mostrarNotificacion('Error: ' + error.message);
            }
        };
        
        // --- FUNCI√ìN DE GUARDADO F√çSICO ---
            const guardarInventarioFisico = async () => {
                if (!confirm("¬øEst√°s seguro de que deseas guardar un registro del inventario f√≠sico actual?")) return;
                try {
                    const token = localStorage.getItem('authToken');
                    const response = await fetch(`${API_URL}/guardar`, { // La URL correcta se construye aqu√≠
                        method: 'POST',
                        headers: { 
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json' 
                        }
                    });

                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || 'Error al guardar el inventario f√≠sico.');
                    }

                    mostrarNotificacion(data.mensaje);
                } catch (error) {
                    console.error('Error al guardar corte:', error);
                    mostrarNotificacion('Error: ' + error.message);
                }
            };

        // --- 3. MANEJADORES DE EVENTOS ---

        // Evento para abrir modal de AGREGAR
        document.getElementById('btn-agregar').addEventListener('click', () => {
            formAgregar.reset(); 
            abrirModal(modalProducto);
        });

        // Evento para aplicar filtros
        btnAplicarFiltro.addEventListener('click', renderInventario);

        // Evento para guardar corte
        btnGuardarCorte.addEventListener('click', guardarInventarioFisico);

        // Evento para manejar EDITAR y ELIMINAR (usando delegaci√≥n)
        tablaBody.addEventListener('click', (e) => {
            const id = e.target.dataset.id;
            
            if (e.target.classList.contains('btn-edit')) {
                // 1. Llenar los campos del modal de Edici√≥n
                document.getElementById('edit-id').value = id;
                document.getElementById('edit-id-display').value = id;
                document.getElementById('edit-nombre').value = e.target.dataset.nombre;
                
                // Llenar campos nuevos de Categor√≠a, Unidad y Stock M√≠nimo
                document.getElementById('edit-categoria').value = e.target.dataset.categoria; 
                document.getElementById('edit-cantidad').value = e.target.dataset.cantidad;
                document.getElementById('edit-unidad').value = e.target.dataset.unidad;
                document.getElementById('edit-stock-minimo').value = e.target.dataset.stockMinimo;
                
                abrirModal(modalEditar);
                
            } else if (e.target.classList.contains('btn-eliminar')) {
                // 2. Abrir modal de Confirmaci√≥n
                productoIdActual = id;
                const nombreInsumo = e.target.closest('tr').querySelector('td:nth-child(2)').textContent;
                insumoAEliminar.textContent = nombreInsumo;
                abrirModal(modalConfirmar);
            }
        });

        // Evento de submit para AGREGAR (Actualizado)
        formAgregar.addEventListener('submit', (e) => {
            e.preventDefault();
            const nombre = document.getElementById('nombre-agregar').value.trim();
            const categoria = document.getElementById('categoria-agregar').value;
            const cantidad = parseInt(document.getElementById('cantidad-agregar').value, 10);
            const unidad = document.getElementById('unidad-agregar').value.trim();
            const stock_minimo = parseInt(document.getElementById('stock-minimo-agregar').value, 10);

            if (!nombre || cantidad < 0 || isNaN(cantidad) || isNaN(stock_minimo) || stock_minimo < 0) {
                alert('Por favor, ingresa un nombre v√°lido y cantidades positivas.');
                return;
            }

            agregarProducto({ nombre, cantidad, unidad, stock_minimo, categoria }); 
        });
        
        // Evento de submit para EDITAR (Actualizado)
        formEditar.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const nombre = document.getElementById('edit-nombre').value.trim();
            const categoria = document.getElementById('edit-categoria').value;
            const cantidad = parseInt(document.getElementById('edit-cantidad').value, 10);
            const unidad = document.getElementById('edit-unidad').value.trim();
            const stock_minimo = parseInt(document.getElementById('edit-stock-minimo').value, 10);

            if (!nombre || cantidad < 0 || isNaN(cantidad) || isNaN(stock_minimo) || stock_minimo < 0) {
                alert('Por favor, ingresa un nombre v√°lido y cantidades positivas.');
                return;
            }
            
            editarProducto(id, { nombre, cantidad, unidad, stock_minimo, categoria });
        });

        // Evento de click para CONFIRMAR ELIMINAR
        btnConfirmarEliminar.addEventListener('click', () => {
            eliminarProducto(productoIdActual);
        });

        // Cerrar modales (botones 'x', cancelar, clic fuera)
        document.querySelectorAll('.close, .btn-cancelar').forEach(el => el.addEventListener('click', cerrarModales));
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) cerrarModales();
        });

        // L√≥gica de Cerrar Sesi√≥n
        document.getElementById('btn-logout').addEventListener('click', () => {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userRole');
            window.location.href = 'login.html';
        });

        // --- 4. INICIALIZACI√ìN ---
        
        const verificarLogin = () => {
            const token = localStorage.getItem('authToken');
            const role = localStorage.getItem('userRole'); 
            
            if (!token || !role) {
                window.location.href = 'login.html';
                return;
            }
            
            renderInventario(); 
        };

        document.addEventListener('DOMContentLoaded', verificarLogin);
    </script>
</body>

</html>
