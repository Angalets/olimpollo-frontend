<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Olimpollo - Comanda Cocina</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ==========================================================================
           BASE DE ESTILOS UNIFICADA (Adaptada para KDS)
           ========================================================================== */
        :root{--bg-main:#ECF0F1;--bg-header:#FFFFFF;--card-bg:#FFFFFF;--primary-text:#502c2c;--secondary-text:#808B96;--accent-color:#db3434;--accent-hover:#b92929;--border-color:#D5D8DC;--shadow-light:0 4px 15px rgba(0, 0, 0, 0.08);--shadow-heavy:0 10px 20px rgba(0, 0, 0, 0.12);}
        body{margin:0;font-family:'Poppins', sans-serif;background-color:var(--bg-main);color:var(--primary-text);padding: 20px;}
        .btn{border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:500;font-family:'Poppins', sans-serif;transition:background-color 0.3s, transform 0.2s;}
        .btn:hover{transform:translateY(-2px);}
        .btn-success{background-color:#2ECC71;color:white;}
        .btn-success:hover{background-color:#28B463;}
        h1 { text-align: center; color: var(--accent-color); margin-bottom: 30px; }

        /* ==========================================================================
           ESTILOS ESPECÍFICOS PARA LA PANTALLA DE COMANDAS (KDS)
           ========================================================================== */
        .comandas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }
        
        /* TARJETA BASE */
        .comanda-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow-light);
            display: flex;
            flex-direction: column;
            border-top: 8px solid #2ECC71; /* Verde por defecto (Nuevo) */
            transition: background-color 0.5s, border-color 0.5s;
        }

        /* --- NUEVO: ESTADOS DE ALERTA VISUAL --- */
        .status-warning {
            border-top-color: #F1C40F; /* Amarillo */
            background-color: #FEF9E7;
        }
        .status-critical {
            border-top-color: #E74C3C; /* Rojo */
            background-color: #FADBD8;
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }

        .comanda-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .comanda-id { font-size: 1.5em; font-weight: 700; color: var(--primary-text); }
        
        /* Nuevo estilo para el cronómetro */
        .timer-badge {
            background-color: #2c3e50;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 1.1em;
            display: inline-block;
            margin-top: 5px;
        }

        .comanda-info { text-align: right; font-size: 0.9em; }
        .comanda-info span { display: block; }
        .comanda-items {
            list-style: none;
            padding: 0;
            margin: 0 0 20px 0;
            flex-grow: 1;
        }
        .comanda-items li {
            font-size: 1.3em;
            font-weight: 500;
            padding: 8px 0;
            border-bottom: 1px dashed var(--bg-main);
        }
        .comanda-items li strong { color: var(--accent-color); margin-right: 10px; }
        .comanda-items li span { font-size: 0.8em; color: var(--secondary-text); display: block; margin-left: 30px; }
        .comanda-actions { margin-top: auto; }
        .btn-entregado {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            font-weight: 600;
        }
        #mensaje-carga { text-align: center; font-size: 1.2em; color: var(--secondary-text); margin-top: 50px; }
    </style>
</head>
<body>
    <h1>Comandas Pendientes - Cocina</h1>
    
    <div id="comandas-container" class="comandas-grid">
        <p id="mensaje-carga">Cargando comandas...</p>
    </div>

    <audio id="alerta-audio" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3"></audio>

    <script>
        // CONFIGURACIÓN DE TIEMPOS (MINUTOS)
        const MINUTOS_WARNING = 15;  // Se pone amarillo a los 15 min
        const MINUTOS_CRITICAL = 25; // Se pone rojo a los 25 min

        function parseJwt(token) { try { const base64Url = token.split('.')[1]; const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/'); const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); return JSON.parse(jsonPayload); } catch (e) { return null; } }

        document.addEventListener('DOMContentLoaded', () => {
            const API_PEDIDOS_URL = 'https://olimpollo-api.onrender.com/api/pedidos';
            const comandasContainer = document.getElementById('comandas-container');
            const mensajeCarga = document.getElementById('mensaje-carga');
            const REFRESH_INTERVAL = 10000; // Refrescar base de datos cada 10 seg

            // --- 1. VERIFICACIÓN DE LOGIN ---
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            // --- 2. FUNCIONES ---
            const fetchPendientes = async () => {
                try {
                    // Pedimos pedidos pendientes o en preparación
                    const response = await fetch(`${API_PEDIDOS_URL}?estado=Pendiente`);
                    if (!response.ok) throw new Error('Error al cargar comandas');
                    let pedidos = await response.json();
                    
                    // Ordenamos: Los más viejos primero (FIFO) para que salgan arriba
                    pedidos.sort((a, b) => new Date(a.fecha_creacion) - new Date(b.fecha_creacion));
                    
                    renderComandas(pedidos);
                } catch (error) {
                    console.error("Error fetching comandas:", error);
                }
            };

            const renderComandas = (pedidos) => {
                // NOTA: Para no parpadear toda la pantalla, idealmente compararíamos IDs,
                // pero por simplicidad reconstruimos. El timer se actualiza aparte.
                comandasContainer.innerHTML = ''; 
                
                if (pedidos.length === 0) {
                    mensajeCarga.style.display = 'block';
                    mensajeCarga.textContent = 'Todo limpio, Chef. Esperando pedidos...';
                    comandasContainer.appendChild(mensajeCarga);
                    return;
                }
                mensajeCarga.style.display = 'none';

                pedidos.forEach(pedido => {
                    const card = document.createElement('div');
                    card.className = 'comanda-card'; // Clase base
                    card.dataset.id = pedido.id;
                    card.dataset.fecha = pedido.fecha_creacion; // IMPORTANTE PARA EL TIMER

                    const hora = new Date(pedido.fecha_creacion).toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
                    
                    let itemsHTML = '';
                    pedido.items.forEach(item => {
                        const match = item.nombre_producto.match(/(.*)\s\((.*)\)/);
                        let nombreBase = item.nombre_producto;
                        let modificadores = '';
                        if (match) {
                            nombreBase = match[1];
                            modificadores = match[2];
                        }
                        itemsHTML += `<li><strong>${item.cantidad}x</strong> ${nombreBase} ${modificadores ? `<span>${modificadores}</span>` : ''}</li>`;
                    });

                    card.innerHTML = `
                        <div class="comanda-header">
                            <div>
                                <span class="comanda-id">#${pedido.id.toString().padStart(3, '0')}</span>
                                <div class="timer-badge">00:00</div> </div>
                            <div class="comanda-info">
                                <span>Cliente: <strong>${pedido.cliente}</strong></span>
                                <span>Canal: ${pedido.canal_venta || 'Mostrador'}</span>
                                <span>Hora: ${hora}</span>
                            </div>
                        </div>
                        <ul class="comanda-items">${itemsHTML}</ul>
                        <div class="comanda-actions">
                            <button class="btn btn-success btn-entregado" data-id="${pedido.id}">Marcar como Entregado</button>
                        </div>
                    `;
                    comandasContainer.appendChild(card);
                });
                
                // Actualizamos los relojes inmediatamente después de dibujar
                actualizarCronometros();
            };

            // --- NUEVA LÓGICA DE CRONÓMETROS Y ALERTAS ---
            const actualizarCronometros = () => {
                const ahora = new Date();
                const tarjetas = document.querySelectorAll('.comanda-card');

                tarjetas.forEach(card => {
                    const fechaCreacion = new Date(card.dataset.fecha);
                    const diffMs = ahora - fechaCreacion;
                    const diffMinutos = Math.floor(diffMs / 60000);
                    const diffSegundos = Math.floor((diffMs % 60000) / 1000);

                    // 1. Actualizar Texto del Timer
                    const timerDiv = card.querySelector('.timer-badge');
                    if (timerDiv) {
                        timerDiv.textContent = `${diffMinutos.toString().padStart(2, '0')}:${diffSegundos.toString().padStart(2, '0')}`;
                    }

                    // 2. Actualizar Colores (Semáforo)
                    card.classList.remove('status-warning', 'status-critical');
                    
                    if (diffMinutos >= MINUTOS_CRITICAL) {
                        card.classList.add('status-critical'); // Rojo + Parpadeo
                    } else if (diffMinutos >= MINUTOS_WARNING) {
                        card.classList.add('status-warning');  // Amarillo
                    }
                });
            };

            const marcarEntregado = async (id) => {
                if (!confirm(`¿Confirmas que el pedido #${id} está listo?`)) return;
                try {
                    // Efecto visual rápido
                    const card = document.querySelector(`.comanda-card[data-id="${id}"]`);
                    if(card) card.style.opacity = '0.5';

                    const response = await fetch(`${API_PEDIDOS_URL}/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ estado: 'Entregado' })
                    });
                    if (!response.ok) throw new Error('Error API');
                    
                    fetchPendientes(); 
                } catch (error) {
                    console.error("Error:", error);
                    alert('No se pudo actualizar. Revisa tu conexión.');
                    const card = document.querySelector(`.comanda-card[data-id="${id}"]`);
                    if(card) card.style.opacity = '1';
                }
            };

            // --- 3. EVENT LISTENERS ---
            comandasContainer.addEventListener('click', (e) => {
                const target = e.target.closest('.btn-entregado');
                if (target) {
                    marcarEntregado(target.dataset.id);
                }
            });

            // --- 4. INICIALIZACIÓN Y TIMERS ---
            fetchPendientes(); 
            
            // Intervalo largo para traer nuevos pedidos de la base de datos (10 seg)
            setInterval(fetchPendientes, REFRESH_INTERVAL); 
            
            // Intervalo corto para mover el cronómetro localmente (1 seg)
            setInterval(actualizarCronometros, 1000); 
        });
    </script>
</body>
</html>
