<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Olimpollo - Comanda Cocina</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root{--bg-main:#ECF0F1;--bg-header:#FFFFFF;--card-bg:#FFFFFF;--primary-text:#502c2c;--secondary-text:#808B96;--accent-color:#db3434;--accent-hover:#b92929;--border-color:#D5D8DC;--shadow-light:0 4px 15px rgba(0, 0, 0, 0.08);--shadow-heavy:0 10px 20px rgba(0, 0, 0, 0.12);}
        body{margin:0;font-family:'Poppins', sans-serif;background-color:var(--bg-main);color:var(--primary-text); display: flex; flex-direction: column; min-height: 100vh;}
        
        #overlay-inicio { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.98); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; }
        .btn-iniciar-turno { padding: 20px 40px; font-size: 2em; background-color: #2ECC71; color: white; border: none; border-radius: 15px; cursor: pointer; font-weight: bold; box-shadow: 0 8px 20px rgba(0,0,0,0.4); transition: transform 0.2s, background 0.2s; margin-top: 30px; font-family: 'Poppins', sans-serif; }
        .btn-iniciar-turno:hover { transform: scale(1.05); background-color: #27ae60; }

        header { background: #2c3e50; color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 22px; font-weight: 700; color: #ecf0f1; text-decoration: none;}
        .clock { font-size: 24px; font-weight: 600; color: #f1c40f; letter-spacing: 1px; }
        .home-btn { color: white; font-size: 24px; transition: color 0.3s; }
        .home-btn:hover { color: #f1c40f; }

        /* BANNER DE ALERTAS */
        #alertas-container { display: none; background-color: #c0392b; color: white; margin: 20px 30px 0 30px; border-radius: 12px; padding: 15px; box-shadow: 0 5px 15px rgba(231,76,60,0.4); animation: pulse-red 2s infinite; }
        .alerta-item { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 15px 20px; border-radius: 8px; margin-bottom: 10px; }
        .alerta-item:last-child { margin-bottom: 0; }
        .alerta-texto { font-size: 1.5em; font-weight: 600; display: flex; align-items: center; gap: 15px;}
        .btn-alerta-hecho { background: white; color: #c0392b; border: none; padding: 10px 25px; border-radius: 8px; font-size: 1.2em; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-alerta-hecho:hover { background: #f1c40f; color: black; }

        main { padding: 30px; flex: 1; }
        .comandas-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }
        .comanda-card { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: var(--shadow-light); display: flex; flex-direction: column; border-top: 8px solid #2ECC71; transition: background-color 0.5s, border-color 0.5s, transform 0.2s; }
        
        .status-warning { border-top-color: #F1C40F; background-color: #FEF9E7; }
        .status-critical { border-top-color: #E74C3C; background-color: #FADBD8; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }

        .comanda-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
        .comanda-id { font-size: 1.5em; font-weight: 700; color: var(--primary-text); }
        .timer-badge { background-color: #2c3e50; color: white; padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 1.1em; display: inline-block; margin-top: 5px; }
        .comanda-info { text-align: right; font-size: 0.9em; }
        .comanda-info span { display: block; }
        .comanda-items { list-style: none; padding: 0; margin: 0 0 20px 0; flex-grow: 1; }
        .comanda-items li { font-size: 1.3em; font-weight: 500; padding: 8px 0; border-bottom: 1px dashed var(--bg-main); }
        .comanda-items li strong { color: var(--accent-color); margin-right: 10px; }
        .comanda-items li span.mods { font-size: 0.8em; color: var(--secondary-text); display: block; margin-left: 30px; font-style: italic; }
        .kitchen-note { display: block; margin-left: 30px; font-size: 0.85em; color: #d35400; background: #fdebd0; padding: 2px 6px; border-radius: 4px; font-weight: 600; margin-top: 4px; width: fit-content; }
        .comanda-actions { margin-top: auto; }
        .btn-entregado { width: 100%; padding: 15px; font-size: 1.1em; background-color: #2ECC71; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .btn-entregado:hover { background-color: #27AE60; }
        #mensaje-carga { text-align: center; font-size: 1.2em; color: var(--secondary-text); margin-top: 50px; grid-column: 1 / -1; }
    </style>
</head>
<body>
    
    <div id="overlay-inicio">
        <h1 style="font-size: 3.5em; margin: 0;">üë®‚Äçüç≥ Cocina Olimpollo</h1>
        <p style="font-size: 1.5em; color: #bdc3c7;">El sistema de alertas sonoras est√° pausado.</p>
        <button id="btn-iniciar-turno" class="btn-iniciar-turno">üîî INICIAR TURNO</button>
    </div>

    <audio id="sonido-pedido" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>
    <audio id="sonido-alerta" src="https://assets.mixkit.co/active_storage/sfx/2866/2866-preview.mp3" preload="auto"></audio>

    <header>
        <a href="index.html" class="logo">Olimpollo <span style="font-weight:400; opacity:0.7;">| Cocina</span></a>
        <div class="clock" id="reloj-header">00:00:00</div>
        <a href="index.html" class="home-btn" title="Salir al Men√∫ Principal"><i class="fas fa-home"></i></a>
    </header>

    <div id="alertas-container">
        <div id="lista-alertas"></div>
    </div>

    <main>
        <div id="comandas-container" class="comandas-grid">
            <p id="mensaje-carga">Esperando a iniciar turno...</p>
        </div>
    </main>

    <script>
        const MINUTOS_WARNING = 15;
        const MINUTOS_CRITICAL = 25;
        const REFRESH_INTERVAL = 10000; 

        document.addEventListener('DOMContentLoaded', () => {
            const API_PEDIDOS_URL = 'https://olimpollo-api.onrender.com/api/pedidos';
            const API_ALERTAS_URL = 'https://olimpollo-api.onrender.com/api/alertas';
            
            const comandasContainer = document.getElementById('comandas-container');
            const alertasContainer = document.getElementById('alertas-container');
            const listaAlertas = document.getElementById('lista-alertas');
            const mensajeCarga = document.getElementById('mensaje-carga');
            const relojHeader = document.getElementById('reloj-header');
            
            const overlayInicio = document.getElementById('overlay-inicio');
            const btnIniciarTurno = document.getElementById('btn-iniciar-turno');
            const sonidoPedido = document.getElementById('sonido-pedido');
            const sonidoAlerta = document.getElementById('sonido-alerta');
            
            let ultimoIdPedido = 0;
            let ultimoIdAlerta = 0;
            let esPrimeraCarga = true;

            const token = localStorage.getItem('authToken');
            if (!token) { window.location.href = 'login.html'; return; }

            // DESBLOQUEO DE AUDIO PARA AMBOS SONIDOS
            btnIniciarTurno.addEventListener('click', () => {
                sonidoPedido.play().then(() => { sonidoPedido.pause(); sonidoPedido.currentTime = 0; }).catch(e=>{});
                sonidoAlerta.play().then(() => { sonidoAlerta.pause(); sonidoAlerta.currentTime = 0; }).catch(e=>{});

                overlayInicio.style.display = 'none';
                mensajeCarga.textContent = 'Conectando con caja...';
                
                fetchData(); 
                setInterval(fetchData, REFRESH_INTERVAL); 
            });

            // FUNCI√ìN PRINCIPAL DE B√öSQUEDA (PEDIDOS Y ALERTAS)
            const fetchData = async () => {
                try {
                    // 1. Buscar Pedidos
                    const resPedidos = await fetch(`${API_PEDIDOS_URL}?estado=Pendiente`);
                    let pedidos = await resPedidos.json();
                    
                    if (pedidos.length > 0) {
                        const maxIdP = Math.max(...pedidos.map(p => p.id));
                        if (esPrimeraCarga) ultimoIdPedido = maxIdP;
                        else if (maxIdP > ultimoIdPedido) {
                            sonidoPedido.play().catch(e=>{});
                            ultimoIdPedido = maxIdP;
                        }
                    }

                    // 2. Buscar Alertas de Intercomunicador
                    const resAlertas = await fetch(API_ALERTAS_URL);
                    let alertas = await resAlertas.json();

                    if (alertas.length > 0) {
                        const maxIdA = Math.max(...alertas.map(a => a.id));
                        if (esPrimeraCarga) ultimoIdAlerta = maxIdA;
                        else if (maxIdA > ultimoIdAlerta) {
                            sonidoAlerta.play().catch(e=>{}); // SUENA EL ZUMBADOR
                            ultimoIdAlerta = maxIdA;
                        }
                    }

                    esPrimeraCarga = false;

                    // Renderizar
                    pedidos.sort((a, b) => new Date(a.fecha_creacion) - new Date(b.fecha_creacion));
                    renderComandas(pedidos);
                    renderAlertas(alertas);

                } catch (error) { console.error("Error fetching data:", error); }
            };

            // RENDER ALERTAS
            const renderAlertas = (alertas) => {
                listaAlertas.innerHTML = '';
                if (alertas.length === 0) {
                    alertasContainer.style.display = 'none';
                    return;
                }
                alertasContainer.style.display = 'block';
                
                alertas.forEach(alerta => {
                    listaAlertas.innerHTML += `
                        <div class="alerta-item">
                            <div class="alerta-texto"><i class="fas fa-bullhorn"></i> ${alerta.mensaje}</div>
                            <button class="btn-alerta-hecho" onclick="completarAlerta(${alerta.id})">‚úî Enterado</button>
                        </div>
                    `;
                });
            };

            window.completarAlerta = async (id) => {
                try {
                    await fetch(`${API_ALERTAS_URL}/${id}`, { method: 'PUT' });
                    fetchData(); // Refrescar r√°pido
                } catch (error) { console.error(error); }
            };

            // RENDER COMANDAS
            const renderComandas = (pedidos) => {
                comandasContainer.innerHTML = ''; 
                if (pedidos.length === 0) {
                    mensajeCarga.style.display = 'block';
                    mensajeCarga.textContent = 'Todo limpio, Chef. Esperando pedidos...';
                    comandasContainer.appendChild(mensajeCarga);
                    return;
                }
                mensajeCarga.style.display = 'none';

                pedidos.forEach(pedido => {
                    const card = document.createElement('div');
                    card.className = 'comanda-card';
                    card.dataset.id = pedido.id;
                    card.dataset.fecha = pedido.fecha_creacion; 

                    const hora = new Date(pedido.fecha_creacion).toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
                    
                    let itemsHTML = '';
                    pedido.items.forEach(item => {
                        const match = item.nombre_producto.match(/(.*)\s\((.*)\)/);
                        let nombreBase = item.nombre_producto;
                        let modificadores = match ? match[2] : '';
                        if (match) nombreBase = match[1];
                        
                        const notaHTML = item.notas ? `<span class="kitchen-note">‚ö†Ô∏è ${item.notas}</span>` : '';
                        itemsHTML += `<li><strong>${item.cantidad}x</strong> ${nombreBase} ${modificadores ? `<span class="mods">${modificadores}</span>` : ''} ${notaHTML}</li>`;
                    });

                    card.innerHTML = `
                        <div class="comanda-header">
                            <div><span class="comanda-id">#${pedido.id.toString().padStart(3, '0')}</span><div class="timer-badge">00:00</div></div>
                            <div class="comanda-info"><span>Cliente: <strong>${pedido.cliente}</strong></span><span>Canal: ${pedido.canal_venta || 'Mostrador'}</span><span>Hora: ${hora}</span></div>
                        </div>
                        <ul class="comanda-items">${itemsHTML}</ul>
                        <div class="comanda-actions"><button class="btn-entregado" data-id="${pedido.id}">‚úî LISTO</button></div>
                    `;
                    comandasContainer.appendChild(card);
                });
                actualizarCronometros();
            };

            // CRONOMETROS Y MARCAR ENTREGADO
            const actualizarCronometros = () => {
                const ahora = new Date();
                if (relojHeader) relojHeader.textContent = ahora.toLocaleTimeString('es-MX');

                document.querySelectorAll('.comanda-card').forEach(card => {
                    const diffMs = ahora - new Date(card.dataset.fecha);
                    const diffMinutos = Math.floor(diffMs / 60000);
                    const timerDiv = card.querySelector('.timer-badge');
                    if (timerDiv) timerDiv.textContent = `${diffMinutos.toString().padStart(2, '0')}:${Math.floor((diffMs % 60000) / 1000).toString().padStart(2, '0')}`;
                    card.classList.remove('status-warning', 'status-critical');
                    if (diffMinutos >= MINUTOS_CRITICAL) card.classList.add('status-critical'); 
                    else if (diffMinutos >= MINUTOS_WARNING) card.classList.add('status-warning');
                });
            };

            comandasContainer.addEventListener('click', async (e) => {
                if (e.target.classList.contains('btn-entregado')) {
                    const id = e.target.dataset.id;
                    if (!confirm(`¬øConfirmas que el pedido #${id} est√° listo?`)) return;
                    try {
                        e.target.closest('.comanda-card').style.opacity = '0.5';
                        await fetch(`${API_PEDIDOS_URL}/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ estado: 'Entregado' }) });
                        fetchData(); 
                    } catch (error) { alert('Error al actualizar.'); }
                }
            });

            setInterval(actualizarCronometros, 1000); 
        });
    </script>
</body>
</html>
