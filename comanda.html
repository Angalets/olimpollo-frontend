<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Olimpollo - Comanda Cocina</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ==========================================================================
           BASE DE ESTILOS UNIFICADA (Adaptada para KDS)
           ========================================================================== */
        :root{--bg-main:#ECF0F1;--bg-header:#FFFFFF;--card-bg:#FFFFFF;--primary-text:#502c2c;--secondary-text:#808B96;--accent-color:#db3434;--accent-hover:#b92929;--border-color:#D5D8DC;--shadow-light:0 4px 15px rgba(0, 0, 0, 0.08);--shadow-heavy:0 10px 20px rgba(0, 0, 0, 0.12);}
        body{margin:0;font-family:'Poppins', sans-serif;background-color:var(--bg-main);color:var(--primary-text);padding: 20px;}
        .btn{border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:500;font-family:'Poppins', sans-serif;transition:background-color 0.3s, transform 0.2s;}
        .btn:hover{transform:translateY(-2px);}
        .btn-success{background-color:#2ECC71;color:white;}
        .btn-success:hover{background-color:#28B463;}
        h1 { text-align: center; color: var(--accent-color); margin-bottom: 30px; }

        /* ==========================================================================
           ESTILOS ESPECÍFICOS PARA LA PANTALLA DE COMANDAS (KDS)
           ========================================================================== */
        .comandas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); /* Columnas responsivas */
            gap: 25px;
        }
        .comanda-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow-light);
            display: flex;
            flex-direction: column;
            border-top: 5px solid var(--accent-color); /* Indicador visual */
        }
        .comanda-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .comanda-id { font-size: 1.5em; font-weight: 700; color: var(--accent-color); }
        .comanda-info { text-align: right; font-size: 0.9em; }
        .comanda-info span { display: block; }
        .comanda-items {
            list-style: none;
            padding: 0;
            margin: 0 0 20px 0;
            flex-grow: 1; /* Para que la lista ocupe el espacio */
        }
        .comanda-items li {
            font-size: 1.3em; /* Texto más grande para cocina */
            font-weight: 500;
            padding: 8px 0;
            border-bottom: 1px dashed var(--bg-main);
        }
        .comanda-items li strong { color: var(--accent-color); margin-right: 10px; } /* Cantidad resaltada */
        .comanda-items li span { font-size: 0.8em; color: var(--secondary-text); display: block; margin-left: 30px; } /* Modificadores */
        .comanda-actions { margin-top: auto; /* Empuja el botón hacia abajo */ }
        .btn-entregado {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            font-weight: 600;
        }
        #mensaje-carga { text-align: center; font-size: 1.2em; color: var(--secondary-text); margin-top: 50px; }
    </style>
</head>
<body>
    <h1>Comandas Pendientes - Cocina</h1>
    
    <div id="comandas-container" class="comandas-grid">
        <p id="mensaje-carga">Cargando comandas...</p>
        </div>

    <script>
        function parseJwt(token) { try { const base64Url = token.split('.')[1]; const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/'); const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); return JSON.parse(jsonPayload); } catch (e) { return null; } }

        document.addEventListener('DOMContentLoaded', () => {
            const API_PEDIDOS_URL = 'https://olimpollo-api.onrender.com/api/pedidos';
            const comandasContainer = document.getElementById('comandas-container');
            const mensajeCarga = document.getElementById('mensaje-carga');
            const REFRESH_INTERVAL = 15000; // Refrescar cada 15 segundos

            // --- 1. VERIFICACIÓN DE LOGIN ---
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            // --- 2. FUNCIONES ---
            const fetchPendientes = async () => {
                try {
                    const response = await fetch(`${API_PEDIDOS_URL}?estado=Pendiente`); // Pide solo los pendientes
                    if (!response.ok) throw new Error('Error al cargar comandas');
                    const pedidos = await response.json();
                    renderComandas(pedidos);
                } catch (error) {
                    console.error("Error fetching comandas:", error);
                    mensajeCarga.textContent = 'Error al cargar comandas. Intentando de nuevo...';
                    comandasContainer.innerHTML = ''; // Limpiar por si había algo antes
                    comandasContainer.appendChild(mensajeCarga);
                }
            };

            const renderComandas = (pedidos) => {
                comandasContainer.innerHTML = ''; // Limpiar contenedor
                if (pedidos.length === 0) {
                    mensajeCarga.textContent = 'No hay comandas pendientes por el momento.';
                    comandasContainer.appendChild(mensajeCarga);
                    return;
                }
                mensajeCarga.style.display = 'none'; // Ocultar mensaje de carga

                pedidos.forEach(pedido => {
                    const card = document.createElement('div');
                    card.className = 'comanda-card';
                    card.dataset.id = pedido.id;

                    const hora = new Date(pedido.fecha_creacion).toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
                    
                    let itemsHTML = '';
                    pedido.items.forEach(item => {
                        // Extraer modificadores si existen
                        const match = item.nombre_producto.match(/(.*)\s\((.*)\)/);
                        let nombreBase = item.nombre_producto;
                        let modificadores = '';
                        if (match) {
                            nombreBase = match[1];
                            modificadores = match[2];
                        }
                        itemsHTML += `<li><strong>${item.cantidad}x</strong> ${nombreBase} ${modificadores ? `<span>${modificadores}</span>` : ''}</li>`;
                    });

                    card.innerHTML = `
                        <div class="comanda-header">
                            <span class="comanda-id">#${pedido.id.toString().padStart(3, '0')}</span>
                            <div class="comanda-info">
                                <span>Cliente: <strong>${pedido.cliente}</strong></span>
                                <span>Canal: ${pedido.canal_venta || 'N/A'}</span>
                                <span>Hora: ${hora}</span>
                            </div>
                        </div>
                        <ul class="comanda-items">${itemsHTML}</ul>
                        <div class="comanda-actions">
                            <button class="btn btn-success btn-entregado" data-id="${pedido.id}">Marcar como Entregado</button>
                        </div>
                    `;
                    comandasContainer.appendChild(card);
                });
            };

            const marcarEntregado = async (id) => {
                if (!confirm(`¿Confirmas que el pedido #${id} está listo y entregado?`)) return;
                try {
                    const response = await fetch(`${API_PEDIDOS_URL}/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ estado: 'Entregado' })
                    });
                    if (!response.ok) throw new Error('Error al actualizar el estado del pedido');
                    
                    // Opcional: Mostrar notificación breve de éxito
                    // mostrarNotificacion(`Pedido #${id} marcado como entregado.`);
                    
                    fetchPendientes(); // Recargar la lista inmediatamente
                } catch (error) {
                    console.error("Error al marcar como entregado:", error);
                    alert('Error: No se pudo actualizar el estado del pedido. ' + error.message);
                }
            };

            // --- 3. EVENT LISTENERS ---
            comandasContainer.addEventListener('click', (e) => {
                const target = e.target.closest('.btn-entregado');
                if (target) {
                    marcarEntregado(target.dataset.id);
                }
            });

            // --- 4. INICIALIZACIÓN Y POLLING ---
            fetchPendientes(); // Carga inicial
            setInterval(fetchPendientes, REFRESH_INTERVAL); // Refresco periódico
        });
    </script>
</body>
</html>
