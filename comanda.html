<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Olimpollo - Comanda Cocina</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* ESTILOS (Mismos de antes + Estilo para nota) */
        :root{--bg-main:#ECF0F1;--bg-header:#FFFFFF;--card-bg:#FFFFFF;--primary-text:#502c2c;--secondary-text:#808B96;--accent-color:#db3434;--accent-hover:#b92929;--border-color:#D5D8DC;--shadow-light:0 4px 15px rgba(0, 0, 0, 0.08);--shadow-heavy:0 10px 20px rgba(0, 0, 0, 0.12);}
        body{margin:0;font-family:'Poppins', sans-serif;background-color:var(--bg-main);color:var(--primary-text); display: flex; flex-direction: column; min-height: 100vh;}
        header { background: #2c3e50; color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 22px; font-weight: 700; color: #ecf0f1; text-decoration: none;}
        .clock { font-size: 24px; font-weight: 600; color: #f1c40f; letter-spacing: 1px; }
        .home-btn { color: white; font-size: 24px; transition: color 0.3s; }
        .home-btn:hover { color: #f1c40f; }
        main { padding: 30px; flex: 1; }
        .comandas-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }
        .comanda-card { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: var(--shadow-light); display: flex; flex-direction: column; border-top: 8px solid #2ECC71; transition: background-color 0.5s, border-color 0.5s, transform 0.2s; }
        .status-warning { border-top-color: #F1C40F; background-color: #FEF9E7; }
        .status-critical { border-top-color: #E74C3C; background-color: #FADBD8; animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
        .comanda-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
        .comanda-id { font-size: 1.5em; font-weight: 700; color: var(--primary-text); }
        .timer-badge { background-color: #2c3e50; color: white; padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 1.1em; display: inline-block; margin-top: 5px; }
        .comanda-info { text-align: right; font-size: 0.9em; }
        .comanda-info span { display: block; }
        .comanda-items { list-style: none; padding: 0; margin: 0 0 20px 0; flex-grow: 1; }
        .comanda-items li { font-size: 1.3em; font-weight: 500; padding: 8px 0; border-bottom: 1px dashed var(--bg-main); }
        .comanda-items li strong { color: var(--accent-color); margin-right: 10px; }
        .comanda-items li span.mods { font-size: 0.8em; color: var(--secondary-text); display: block; margin-left: 30px; font-style: italic; }
        
        /* ESTILO DE LA NOTA DE COCINA */
        .kitchen-note { 
            display: block; 
            margin-left: 30px; 
            font-size: 0.85em; 
            color: #d35400; /* Naranja oscuro */
            background: #fdebd0; 
            padding: 2px 6px; 
            border-radius: 4px;
            font-weight: 600;
            margin-top: 4px;
            width: fit-content;
        }

        .comanda-actions { margin-top: auto; }
        .btn { border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: 'Poppins', sans-serif; transition: 0.3s; }
        .btn-entregado { width: 100%; padding: 15px; font-size: 1.1em; background-color: #2ECC71; color: white; }
        .btn-entregado:hover { background-color: #27AE60; }
        #mensaje-carga { text-align: center; font-size: 1.2em; color: var(--secondary-text); margin-top: 50px; grid-column: 1 / -1; }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">Olimpollo <span style="font-weight:400; opacity:0.7;">| Cocina</span></a>
        <div class="clock" id="reloj-header">00:00:00</div>
        <a href="index.html" class="home-btn" title="Salir al Menú Principal"><i class="fas fa-home"></i></a>
    </header>
    <main>
        <div id="comandas-container" class="comandas-grid">
            <p id="mensaje-carga">Conectando con cocina...</p>
        </div>
    </main>
    <script>
        const MINUTOS_WARNING = 15;
        const MINUTOS_CRITICAL = 25;
        function parseJwt(token) { try { const base64Url = token.split('.')[1]; const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/'); const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); return JSON.parse(jsonPayload); } catch (e) { return null; } }

        document.addEventListener('DOMContentLoaded', () => {
            const API_PEDIDOS_URL = 'https://olimpollo-api.onrender.com/api/pedidos';
            const comandasContainer = document.getElementById('comandas-container');
            const mensajeCarga = document.getElementById('mensaje-carga');
            const relojHeader = document.getElementById('reloj-header');
            const REFRESH_INTERVAL = 10000;

            const token = localStorage.getItem('authToken');
            if (!token) { window.location.href = 'login.html'; return; }

            const fetchPendientes = async () => {
                try {
                    const response = await fetch(`${API_PEDIDOS_URL}?estado=Pendiente`);
                    if (!response.ok) throw new Error('Error al cargar comandas');
                    let pedidos = await response.json();
                    pedidos.sort((a, b) => new Date(a.fecha_creacion) - new Date(b.fecha_creacion));
                    renderComandas(pedidos);
                } catch (error) { console.error("Error fetching comandas:", error); }
            };

            const renderComandas = (pedidos) => {
                comandasContainer.innerHTML = ''; 
                if (pedidos.length === 0) {
                    mensajeCarga.style.display = 'block';
                    mensajeCarga.textContent = 'Todo limpio, Chef. Esperando pedidos...';
                    comandasContainer.appendChild(mensajeCarga);
                    return;
                }
                mensajeCarga.style.display = 'none';

                pedidos.forEach(pedido => {
                    const card = document.createElement('div');
                    card.className = 'comanda-card';
                    card.dataset.id = pedido.id;
                    card.dataset.fecha = pedido.fecha_creacion; 
                    const hora = new Date(pedido.fecha_creacion).toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
                    
                    let itemsHTML = '';
                    pedido.items.forEach(item => {
                        const match = item.nombre_producto.match(/(.*)\s\((.*)\)/);
                        let nombreBase = item.nombre_producto;
                        let modificadores = '';
                        if (match) { nombreBase = match[1]; modificadores = match[2]; }
                        
                        // RENDERIZADO DE NOTA
                        const notaHTML = item.notas ? `<span class="kitchen-note">⚠️ ${item.notas}</span>` : '';

                        itemsHTML += `
                            <li>
                                <strong>${item.cantidad}x</strong> ${nombreBase} 
                                ${modificadores ? `<span class="mods">${modificadores}</span>` : ''}
                                ${notaHTML}
                            </li>`;
                    });

                    card.innerHTML = `
                        <div class="comanda-header">
                            <div>
                                <span class="comanda-id">#${pedido.id.toString().padStart(3, '0')}</span>
                                <div class="timer-badge">00:00</div>
                            </div>
                            <div class="comanda-info">
                                <span>Cliente: <strong>${pedido.cliente}</strong></span>
                                <span>Canal: ${pedido.canal_venta || 'Mostrador'}</span>
                                <span>Hora: ${hora}</span>
                            </div>
                        </div>
                        <ul class="comanda-items">${itemsHTML}</ul>
                        <div class="comanda-actions">
                            <button class="btn btn-entregado" data-id="${pedido.id}">✔ LISTO</button>
                        </div>
                    `;
                    comandasContainer.appendChild(card);
                });
                actualizarCronometros();
            };

            const actualizarCronometros = () => {
                const ahora = new Date();
                if (relojHeader) relojHeader.textContent = ahora.toLocaleTimeString('es-MX');
                const tarjetas = document.querySelectorAll('.comanda-card');
                tarjetas.forEach(card => {
                    const fechaCreacion = new Date(card.dataset.fecha);
                    const diffMs = ahora - fechaCreacion;
                    const diffMinutos = Math.floor(diffMs / 60000);
                    const diffSegundos = Math.floor((diffMs % 60000) / 1000);
                    const timerDiv = card.querySelector('.timer-badge');
                    if (timerDiv) timerDiv.textContent = `${diffMinutos.toString().padStart(2, '0')}:${diffSegundos.toString().padStart(2, '0')}`;
                    card.classList.remove('status-warning', 'status-critical');
                    if (diffMinutos >= MINUTOS_CRITICAL) { card.classList.add('status-critical'); } 
                    else if (diffMinutos >= MINUTOS_WARNING) { card.classList.add('status-warning'); }
                });
            };

            const marcarEntregado = async (id) => {
                if (!confirm(`¿Confirmas que el pedido #${id} está listo?`)) return;
                try {
                    const card = document.querySelector(`.comanda-card[data-id="${id}"]`);
                    if(card) card.style.opacity = '0.5';
                    const response = await fetch(`${API_PEDIDOS_URL}/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ estado: 'Entregado' })
                    });
                    if (!response.ok) throw new Error('Error API');
                    fetchPendientes(); 
                } catch (error) { console.error("Error:", error); alert('No se pudo actualizar.'); }
            };

            comandasContainer.addEventListener('click', (e) => {
                const target = e.target.closest('.btn-entregado');
                if (target) marcarEntregado(target.dataset.id);
            });

            fetchPendientes(); 
            setInterval(fetchPendientes, REFRESH_INTERVAL); 
            setInterval(actualizarCronometros, 1000); 
        });
    </script>
</body>
</html>
